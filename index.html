<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan NGO - Smart Budgeting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af', 
                        secondary: '#0f172a',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col md:flex-row">

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-secondary text-white flex-shrink-0 fixed md:static bottom-0 z-40 md:h-screen shadow-xl flex flex-col justify-between">
        <div>
            <div class="p-6 hidden md:block">
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-hand-holding-heart mr-2"></i>NGO Finance</h1>
                <p class="text-xs text-gray-400 mt-1">v10.0 Smart Calculator</p>
            </div>
            <nav class="md:mt-4 flex md:flex-col overflow-x-auto md:overflow-visible w-full bg-secondary">
                <a href="#" onclick="showSection('dashboard')" class="nav-item active-nav block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-primary bg-gray-800" id="nav-dashboard">
                    <i class="fa-solid fa-chart-line w-6"></i> Dashboard
                </a>
                <a href="#" onclick="showSection('input')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-input">
                    <i class="fa-solid fa-plus-circle w-6"></i> Transaksi
                </a>
                <a href="#" onclick="showSection('events')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-events">
                    <i class="fa-solid fa-calendar-check w-6"></i> Data Acara
                </a>
                <a href="#" onclick="showSection('regions')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-regions">
                    <i class="fa-solid fa-wallet w-6"></i> Budget Regional
                </a>
            </nav>
        </div>
        
        <div class="p-4 bg-gray-800 md:block hidden">
            <button onclick="checkDatabaseHealth(true)" class="flex items-center space-x-2 text-xs text-gray-400 hover:text-white transition w-full">
                <div id="db-status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span id="db-status-text">Cek Koneksi Database</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto mb-16 md:mb-0">
        
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
            <div class="bg-white p-5 rounded-lg shadow-lg flex items-center">
                <i class="fa-solid fa-spinner fa-spin text-primary text-2xl mr-3"></i>
                <span>Memproses...</span>
            </div>
        </div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="content-section space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-lg shadow-sm">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-sm text-gray-500">Status Keuangan & Anggaran</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                    <select id="dashboard-filter-region" onchange="handleRegionFilterChange()" class="filter-select"><option value="all">Semua Regional</option></select>
                    <select id="dashboard-filter-event" onchange="applyFilter()" class="filter-select disabled:bg-gray-100" disabled><option value="all">Semua Acara</option></select>
                    <div class="flex gap-2">
                        <button onclick="fetchAllData()" class="btn-icon"><i class="fa-solid fa-arrows-rotate"></i></button>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-sm font-bold"><i class="fa-solid fa-file-excel mr-2"></i>Export</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stats-card border-green-500"><div class="title">Total Pemasukan</div><div class="value text-green-600" id="total-income">Rp 0</div></div>
                <div class="stats-card border-red-500"><div class="title">Total Pengeluaran</div><div class="value text-red-600" id="total-expense">Rp 0</div></div>
                <div class="stats-card border-blue-500"><div class="title">Saldo Akhir</div><div class="value text-blue-800" id="net-balance">Rp 0</div></div>
            </div>

            <!-- Budget Overview Container -->
            <div id="budget-overview" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Status Anggaran Regional</h3>
                <div id="budget-bars" class="space-y-4"></div>
            </div>

            <!-- Budget Detail per Acara -->
            <div id="event-budget-detail" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Detail Anggaran per Acara</h3>
                <div class="mb-4">
                    <select id="region-selector" onchange="updateEventBudgetDetail()" class="filter-select">
                        <option value="all">Semua Regional</option>
                    </select>
                </div>
                <div id="event-budget-list" class="space-y-4"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Arus Kas Bulanan</h3><div class="relative h-[280px]"><canvas id="cashFlowChart"></canvas></div></div>
                <div class="chart-container"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2" id="breakdown-title">Distribusi</h3><div class="relative h-[280px] flex justify-center"><canvas id="breakdownChart"></canvas></div></div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b bg-gray-50 font-bold text-gray-700">Riwayat Transaksi</div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-100 text-gray-600"><tr><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Regional / Acara</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3 text-right">Jumlah</th><th class="px-4 py-3 text-center">Aksi</th></tr></thead><tbody id="transaction-list" class="divide-y divide-gray-200"></tbody></table></div>
            </div>
        </section>

        <!-- INPUT SECTION -->
        <section id="input" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Input Transaksi</h2>
            <div class="bg-white p-6 rounded-lg shadow max-w-4xl mx-auto border-t-4 border-primary">
                <form id="transaction-form" onsubmit="handleTransactionSubmit(event)">
                    <input type="hidden" id="t-id">
                    <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 mb-6 relative">
                        <div class="absolute top-4 right-4 flex items-center bg-white px-3 py-1 rounded-full shadow-sm border border-blue-100">
                            <input type="checkbox" id="keep-context" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                            <label for="keep-context" class="ml-2 text-xs font-bold text-blue-700 cursor-pointer select-none">Input Beruntun</label>
                        </div>
                        <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-4">1. Konteks</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="label-text">Regional</label>
                                <div class="flex gap-2"><select id="t-region" class="input-field bg-white" onchange="loadEventsForRegion(this.value)" required></select><button type="button" onclick="quickAddRegion()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Tambah Regional"><i class="fa-solid fa-plus"></i></button></div>
                            </div>
                            <div>
                                <label class="label-text">Acara (Program)</label>
                                <div class="flex gap-2"><select id="t-event-select" class="input-field bg-white" required><option value="">-- Pilih Regional Dahulu --</option></select><button type="button" onclick="quickAddEvent()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Buat Acara Baru dengan Kalkulator"><i class="fa-solid fa-calculator"></i></button></div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3 px-1">2. Detail</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label-text">Jenis</label><select id="t-type" class="input-field font-bold" required><option value="expense" class="text-red-600">Pengeluaran</option><option value="income" class="text-green-600">Pemasukan</option></select></div>
                        <div class="md:col-span-2"><label class="label-text">Kategori</label><input type="text" id="t-category" list="cat-list" class="input-field" required><datalist id="cat-list"><option value="Konsumsi"><option value="Transport"><option value="Donasi"></datalist></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="label-text">Jumlah (Rp)</label><input type="number" id="t-amount" min="1" class="input-field font-bold" required></div>
                        <div><label class="label-text">Tanggal</label><input type="date" id="t-date" class="input-field" required></div>
                    </div>
                    <div class="mb-4"><label class="label-text">Ket</label><textarea id="t-desc" rows="2" class="input-field"></textarea></div>
                    <div class="mb-6"><label class="label-text">Bukti</label><input type="file" id="t-proof" class="input-field p-2 bg-gray-50" accept="image/*"><div id="current-proof" class="mt-2 text-xs hidden"><a href="#" target="_blank" id="current-proof-link" class="text-blue-600">Lihat bukti</a></div></div>
                    <div class="flex gap-3"><button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded shadow-lg">Simpan</button><button type="button" onclick="resetForm(true)" class="px-5 bg-gray-200 rounded">Reset</button></div>
                </form>
            </div>
        </section>

        <!-- EVENTS -->
        <section id="events" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Manajemen Acara & Budget</h2>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Daftar Acara & Realisasi Anggaran</h3>
                    <button onclick="fetchEvents()" class="bg-gray-100 px-3 py-1 rounded text-sm"><i class="fa-solid fa-sync"></i> Refresh</button>
                </div>
                
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="p-3">Regional</th>
                                <th class="p-3">Nama Acara</th>
                                <th class="p-3 text-center">Status</th>
                                <th class="p-3 w-1/3">Penggunaan Anggaran</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-event-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REGIONS -->
        <section id="regions" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Regional & Anggaran</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit border-t-4 border-green-600"><h3 class="font-bold mb-4">Tambah Regional</h3><div class="space-y-4"><div><label class="label-text">Nama</label><input type="text" id="new-region-name" class="input-field"></div><div><label class="label-text">Budget (0 = Unlimited)</label><input type="number" id="new-region-budget" class="input-field" value="0"></div><button onclick="addRegion()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Simpan</button></div></div>
                <div class="bg-white p-6 rounded-lg shadow"><div class="flex justify-between mb-3"><h3 class="font-bold">List Regional</h3><button onclick="fetchRegions()" class="text-blue-600"><i class="fa-solid fa-refresh"></i></button></div><div class="overflow-y-auto max-h-[600px]"><ul id="regions-list" class="divide-y divide-gray-100"></ul></div></div>
            </div>
        </section>

    </main>

    <!-- Modals & Styles -->
    <div id="image-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4" onclick="closeModal()"><img id="modal-img" src="" class="max-h-screen max-w-full rounded shadow-lg"><button class="absolute top-5 right-5 text-white text-3xl">&times;</button></div>
    <div id="sql-modal" class="hidden fixed inset-0 z-[70] bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
            <h3 class="text-xl font-bold text-red-600 mb-2">Setup Database Supabase</h3>
            <p class="text-sm text-gray-600 mb-4">Jalankan SQL berikut di SQL Editor Supabase untuk membuat tabel yang diperlukan:</p>
            <div class="bg-gray-100 p-4 rounded text-xs font-mono overflow-auto max-h-96 mb-4 select-all" id="sql-code">
-- Hapus tabel jika sudah ada (opsional)
DROP TABLE IF EXISTS transactions CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS regions CASCADE;

-- Buat tabel regions
CREATE TABLE regions (
    id BIGSERIAL PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    name TEXT UNIQUE NOT NULL,
    budget_limit NUMERIC DEFAULT 0
);

-- Buat tabel events
CREATE TABLE events (
    id BIGSERIAL PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    region TEXT NOT NULL,
    name TEXT NOT NULL,
    status TEXT DEFAULT 'active',
    budget_limit NUMERIC DEFAULT 0,
    UNIQUE(region, name)
);

-- Buat tabel transactions
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    amount NUMERIC NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    region TEXT NOT NULL,
    event_name TEXT,
    category TEXT,
    description TEXT,
    proof_url TEXT
);

-- Enable Row Level Security
ALTER TABLE regions ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Buat policies untuk akses public
CREATE POLICY "Allow all operations on regions" ON regions FOR ALL USING (true);
CREATE POLICY "Allow all operations on events" ON events FOR ALL USING (true);
CREATE POLICY "Allow all operations on transactions" ON transactions FOR ALL USING (true);

-- Insert sample data untuk testing (opsional)
INSERT INTO regions (name, budget_limit) VALUES 
('Jakarta', 10000000),
('Bandung', 5000000),
('Surabaya', 8000000)
ON CONFLICT (name) DO NOTHING;

INSERT INTO events (region, name, budget_limit) VALUES 
('Jakarta', 'Seminar Pendidikan', 3000000),
('Bandung', 'Workshop Teknologi', 2000000),
('Surabaya', 'Bazaar UMKM', 4000000)
ON CONFLICT (region, name) DO NOTHING;
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
                <h4 class="font-bold text-yellow-800 mb-2">Cara Setup:</h4>
                <ol class="list-decimal pl-5 text-sm text-yellow-700 space-y-1">
                    <li>Buka <a href="https://supabase.com/dashboard/project/ljhcszzmuaourbwwozmf/sql" target="_blank" class="underline font-bold">Supabase SQL Editor</a></li>
                    <li>Salin seluruh kode SQL di atas</li>
                    <li>Tempel di SQL Editor dan klik "Run"</li>
                    <li>Tunggu hingga proses selesai (harus ada pesan success)</li>
                    <li>Refresh halaman aplikasi ini</li>
                </ol>
            </div>
            <div class="flex gap-2">
                <button onclick="copySqlCode()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded font-bold">Salin Kode SQL</button>
                <button onclick="document.getElementById('sql-modal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded">Tutup</button>
            </div>
        </div>
    </div>
    <style>
        .input-field {width:100%;padding:0.6rem;border:1px solid #d1d5db;border-radius:0.375rem;outline:none}
        .input-field:focus{border-color:#1e40af;box-shadow:0 0 0 3px rgba(30,64,175,0.1)}
        .filter-select{padding:0.5rem 1rem;border:1px solid #e5e7eb;border-radius:0.375rem;outline:none}
        .btn-icon{padding:0.5rem 1rem;background:#fff;border:1px solid #e5e7eb;border-radius:0.375rem}
        .stats-card{background:white;padding:1.25rem;border-radius:0.5rem;border-left-width:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .chart-container{background:white;padding:1rem;border-radius:0.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);height:280px;position:relative}
        .budget-card {background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6;}
        .budget-card.overbudget {border-left-color: #ef4444; background-color: #fef2f2;}
        .budget-card.nearly-over {border-left-color: #f59e0b; background-color: #fffbeb;}
        .budget-card.healthy {border-left-color: #10b981; background-color: #f0fdf4;}
        .label-text {display:block;margin-bottom:0.5rem;font-weight:600;font-size:0.875rem;color:#374151}
        .nav-item {display: flex; align-items: center;}
        .nav-item i {width: 24px; text-align: center;}
    </style>

    <script>
        const SUPABASE_URL = 'https://ljhcszzmuaourbwwozmf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let regionsData=[], transactions=[], eventsList=[], currentRegionFilter='all', currentEventFilter='all', isEditing=false, cashFlowChartInstance=null, breakdownChartInstance=null;

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('t-date').valueAsDate = new Date();
            fetchAllData(); 
            checkDatabaseHealth();
        });

        function copySqlCode() {
            const sqlCode = document.getElementById('sql-code').innerText;
            navigator.clipboard.writeText(sqlCode).then(() => {
                Swal.fire('Berhasil!', 'Kode SQL telah disalin ke clipboard', 'success');
            });
        }

        async function checkDatabaseHealth(manual = false) {
            const dot = document.getElementById('db-status-dot');
            const text = document.getElementById('db-status-text');
            
            try {
                // Test query untuk cek apakah tabel regions ada
                const { data, error } = await supabase.from('regions').select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === '42P01' || error.message.includes('does not exist')) {
                        dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                        text.innerText = "DB Error (Klik)";
                        if(!window.hasShownSqlModal || manual) {
                            document.getElementById('sql-modal').classList.remove('hidden');
                        }
                        window.hasShownSqlModal = true;
                    } else {
                        dot.className = "w-2 h-2 rounded-full bg-yellow-500";
                        text.innerText = "DB Warning";
                    }
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-green-500";
                    text.innerText = "DB OK";
                    if(manual) Swal.fire('Koneksi Bagus', 'Semua tabel ditemukan.', 'success');
                }
            } catch (e) {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.innerText = "DB Error";
            }
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => { 
                el.classList.remove('bg-gray-800','border-primary'); 
                el.classList.add('border-transparent'); 
            });
            document.getElementById('nav-'+id).classList.add('bg-gray-800','border-primary');
            document.getElementById('nav-'+id).classList.remove('border-transparent');
            if(['dashboard','events','regions'].includes(id)) fetchAllData();
        }

        async function fetchAllData() {
            showLoading(true);
            try { 
                await Promise.all([fetchRegions(), fetchTransactions(), fetchEvents()]); 
                updateEventBudgetDetail();
            } catch(e) { 
                console.error('Error fetching all data:', e);
                Swal.fire('Error', 'Gagal mengambil data: ' + e.message, 'error');
            } finally { 
                showLoading(false); 
            }
        }

        // --- REGIONS ---
        async function fetchRegions() {
            try {
                const { data, error } = await supabase.from('regions').select('*').order('name');
                if (error) throw error;
                regionsData = data || []; 
                renderRegionsUI(); 
                updateBudgetOverview();
                updateRegionSelector();
            } catch (error) {
                console.error('Error fetching regions:', error);
                // Jangan tampilkan error di sini, biar checkDatabaseHealth yang handle
            }
        }

        function updateRegionSelector() {
            const selector = document.getElementById('region-selector');
            if (!selector) return;
            selector.innerHTML = '<option value="all">Semua Regional</option>';
            regionsData.forEach(r => {
                selector.add(new Option(r.name, r.name));
            });
        }

        async function addRegion() {
            const name = document.getElementById('new-region-name').value.trim();
            const budget = parseFloat(document.getElementById('new-region-budget').value) || 0;
            
            if (!name) {
                Swal.fire('Error', 'Nama regional harus diisi', 'error');
                return;
            }

            showLoading(true);
            try {
                const { error } = await supabase.from('regions').upsert(
                    { name, budget_limit: budget }, 
                    { onConflict: 'name' }
                );
                
                if (error) throw error;
                
                document.getElementById('new-region-name').value = '';
                document.getElementById('new-region-budget').value = '0';
                await fetchRegions();
                Swal.fire('Sukses', 'Regional berhasil disimpan', 'success');
            } catch (error) {
                Swal.fire('Error', 'Gagal menyimpan regional: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function quickAddRegion() {
            const { value: name } = await Swal.fire({
                title: 'Tambah Regional', 
                html: '<input id="q-reg" class="swal2-input" placeholder="Nama Regional">', 
                preConfirm: () => document.getElementById('q-reg').value
            });
            
            if (name) { 
                showLoading(true);
                try {
                    const { error } = await supabase.from('regions').insert([{ name }]);
                    if (error) throw error;
                    await fetchRegions();
                    document.getElementById('t-region').value = name;
                    loadEventsForRegion(name);
                    Swal.fire('Sukses', 'Regional berhasil ditambah', 'success');
                } catch (error) {
                    Swal.fire('Error', 'Gagal menambah regional: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function deleteRegion(name) {
            const { isConfirmed } = await Swal.fire({
                title: 'Hapus Regional?', 
                text: `Regional "${name}" akan dihapus permanen`,
                icon: 'warning', 
                showCancelButton: true
            });
            
            if (isConfirmed) {
                showLoading(true);
                try {
                    const { error } = await supabase.from('regions').delete().eq('name', name);
                    if (error) throw error;
                    await fetchRegions();
                    Swal.fire('Sukses', 'Regional berhasil dihapus', 'success');
                } catch (error) {
                    Swal.fire('Error', 'Gagal menghapus regional: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function renderRegionsUI() {
            const list = document.getElementById('regions-list');
            const select = document.getElementById('t-region');
            const filter = document.getElementById('dashboard-filter-region');
            
            if (!list || !select || !filter) return;
            
            list.innerHTML = '';
            select.innerHTML = '<option value="">-- Pilih --</option>';
            filter.innerHTML = '<option value="all">Semua Regional</option>';
            
            const currentSelect = select.value;
            const currentFilter = filter.value;
            
            regionsData.forEach(region => {
                // Render list
                list.innerHTML += `
                    <li class="py-2 border-b flex justify-between items-center">
                        <div>
                            <b>${region.name}</b> 
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded ml-2">
                                Limit: ${formatRupiah(region.budget_limit)}
                            </span>
                        </div>
                        <button onclick="deleteRegion('${region.name}')" class="text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </li>
                `;
                
                // Render selects
                select.add(new Option(region.name, region.name));
                filter.add(new Option(region.name, region.name));
            });
            
            // Maintain current selections
            if (regionsData.some(r => r.name === currentSelect)) select.value = currentSelect;
            if (currentFilter === 'all' || regionsData.some(r => r.name === currentFilter)) {
                filter.value = currentFilter;
            } else {
                filter.value = 'all';
            }
        }

        // --- EVENTS ---
        async function fetchEvents() {
            try {
                const { data, error } = await supabase.from('events').select('*').order('name');
                if (error) throw error;
                eventsList = data || []; 
                renderMasterEventList(); 
                
                const currentRegion = document.getElementById('t-region').value;
                if (currentRegion) loadEventsForRegion(currentRegion);
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        function loadEventsForRegion(region, selectedEvent = null) {
            const select = document.getElementById('t-event-select');
            if (!select) return;
            
            select.innerHTML = '';
            
            if (!region) {
                select.add(new Option('-- Pilih Regional Dahulu --', ''));
                return;
            }
            
            select.add(new Option('-- Pilih Acara --', ''));
            
            // Filter events by region and active status
            eventsList
                .filter(event => event.region === region && event.status !== 'completed')
                .forEach(event => {
                    select.add(new Option(event.name, event.name));
                });
            
            select.add(new Option('Operasional Rutin', 'Operasional Rutin'));
            
            if (selectedEvent) select.value = selectedEvent;
        }

        async function quickAddEvent() {
            const region = document.getElementById('t-region').value;
            if (!region) {
                Swal.fire('Info', 'Pilih Regional terlebih dahulu', 'info');
                return;
            }

            const { value: formValues } = await Swal.fire({
                title: 'Buat Acara Baru',
                html: `
                    <div class="text-left space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">Nama Acara</label>
                            <input id="swal-ev-name" class="swal2-input m-0 w-full" placeholder="Contoh: Seminar Pendidikan 2024">
                        </div>
                        <div class="border-t pt-3">
                            <label class="text-xs font-bold text-blue-600 block mb-2">
                                <i class="fa-solid fa-calculator mr-1"></i>Kalkulator Budget (Opsional)
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-gray-400">Harga / Tiket</label>
                                    <input id="swal-ev-price" type="number" class="border rounded p-2 w-full text-sm" placeholder="0" oninput="calcSwalTotal()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-400">Jumlah Peserta</label>
                                    <input id="swal-ev-pax" type="number" class="border rounded p-2 w-full text-sm" placeholder="0" oninput="calcSwalTotal()">
                                </div>
                            </div>
                            <div class="mt-2 text-right">
                                <span class="text-xs text-gray-500">Total Proyeksi:</span>
                                <div id="swal-total-display" class="font-bold text-lg text-green-600">Rp 0</div>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-400">- atau -</div>
                        <div>
                            <label class="text-[10px] text-gray-400">Set Manual Budget Limit</label>
                            <input id="swal-ev-manual" type="number" class="border rounded p-2 w-full text-sm" placeholder="Manual budget limit">
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan Acara',
                preConfirm: () => {
                    const name = document.getElementById('swal-ev-name').value;
                    const price = parseFloat(document.getElementById('swal-ev-price').value) || 0;
                    const pax = parseFloat(document.getElementById('swal-ev-pax').value) || 0;
                    const manual = document.getElementById('swal-ev-manual').value;
                    
                    if (!name) {
                        Swal.showValidationMessage('Nama acara wajib diisi');
                        return false;
                    }
                    
                    let budgetLimit = 0;
                    if (manual) {
                        budgetLimit = parseFloat(manual);
                    } else {
                        budgetLimit = price * pax;
                    }

                    return { name, budgetLimit };
                },
                didOpen: () => {
                    window.calcSwalTotal = () => {
                        const price = parseFloat(document.getElementById('swal-ev-price').value) || 0;
                        const pax = parseFloat(document.getElementById('swal-ev-pax').value) || 0;
                        const total = price * pax;
                        document.getElementById('swal-total-display').innerText = formatRupiah(total);
                    };
                }
            });

            if (formValues) {
                const { name, budgetLimit } = formValues;
                showLoading(true);
                try {
                    const { error } = await supabase.from('events').insert([{
                        region: region,
                        name: name,
                        budget_limit: budgetLimit,
                        status: 'active'
                    }]);
                    
                    if (error) throw error;
                    
                    await fetchEvents();
                    loadEventsForRegion(region, name);
                    
                    let message = `Acara "${name}" berhasil dibuat.`;
                    if (budgetLimit > 0) {
                        message += ` Budget limit: ${formatRupiah(budgetLimit)}`;
                    }
                    Swal.fire('Berhasil', message, 'success');
                } catch (error) {
                    Swal.fire('Error', 'Gagal membuat acara: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function updateEventBudget(eventId, eventName, currentBudget) {
            const { value: newBudget } = await Swal.fire({
                title: `Update Budget: ${eventName}`,
                html: `
                    <div class="text-left space-y-3">
                        <div class="bg-blue-50 p-3 rounded">
                            <label class="text-xs font-bold text-blue-600 block mb-2">Hitung Ulang Budget</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="swal-up-price" type="number" class="border rounded p-2 w-full text-sm" placeholder="Harga per peserta" oninput="calcUpTotal()">
                                <input id="swal-up-pax" type="number" class="border rounded p-2 w-full text-sm" placeholder="Jumlah peserta" oninput="calcUpTotal()">
                            </div>
                            <div class="mt-2 flex justify-between items-center">
                                <span class="text-xs text-gray-500">Hasil:</span>
                                <span id="swal-up-total" class="font-bold text-green-600">Rp 0</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Budget Limit Final</label>
                            <input id="swal-up-final" type="number" class="swal2-input m-0 w-full" value="${currentBudget}">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Update Budget',
                preConfirm: () => {
                    const finalValue = parseFloat(document.getElementById('swal-up-final').value) || 0;
                    return finalValue;
                },
                didOpen: () => {
                    window.calcUpTotal = () => {
                        const price = parseFloat(document.getElementById('swal-up-price').value) || 0;
                        const pax = parseFloat(document.getElementById('swal-up-pax').value) || 0;
                        const total = price * pax;
                        document.getElementById('swal-up-total').innerText = formatRupiah(total);
                        document.getElementById('swal-up-final').value = total;
                    };
                }
            });

            if (newBudget !== undefined) {
                showLoading(true);
                try {
                    const { error } = await supabase
                        .from('events')
                        .update({ budget_limit: newBudget })
                        .eq('id', eventId);

                    if (error) throw error;

                    await fetchEvents();
                    updateEventBudgetDetail();
                    Swal.fire('Berhasil', `Budget berhasil diupdate menjadi ${formatRupiah(newBudget)}`, 'success');
                } catch (error) {
                    console.error('Update budget error:', error);
                    Swal.fire('Error', `Gagal update budget: ${error.message}`, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function renderMasterEventList() {
            const tbody = document.getElementById('master-event-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!eventsList.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-4 text-center text-gray-500">
                            Belum ada acara. Buat acara baru di menu Input Transaksi.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calculate usage for each event
            const usageMap = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (t.event_name) {
                        usageMap[t.event_name] = (usageMap[t.event_name] || 0) + t.amount;
                    }
                });

            eventsList.forEach(event => {
                const status = event.status !== 'completed' 
                    ? '<span class="text-green-600 font-bold">Aktif</span>' 
                    : '<span class="text-gray-400">Arsip</span>';
                
                const statusButton = event.status !== 'completed'
                    ? `<button onclick="toggleEventStatus(${event.id}, 'completed')" class="text-xs border border-gray-300 px-2 py-1 rounded hover:bg-gray-100">Arsipkan</button>`
                    : `<button onclick="toggleEventStatus(${event.id}, 'active')" class="text-xs text-blue-600 border border-blue-300 px-2 py-1 rounded hover:bg-blue-50">Aktifkan</button>`;
                
                let budgetDisplay = '<span class="text-xs text-gray-400">Tidak ada limit budget</span>';
                
                if (event.budget_limit > 0) {
                    const used = usageMap[event.name] || 0;
                    const percentage = Math.min((used / event.budget_limit) * 100, 100);
                    const barColor = used > event.budget_limit ? 'bg-red-600' : (percentage > 80 ? 'bg-orange-500' : 'bg-blue-600');
                    
                    budgetDisplay = `
                        <div class="cursor-pointer group" onclick="updateEventBudget(${event.id}, '${event.name}', ${event.budget_limit})" title="Klik untuk edit budget">
                            <div class="flex justify-between text-xs mb-1">
                                <span>${formatRupiah(used)}</span>
                                <span class="font-bold text-gray-600 group-hover:text-blue-600 transition">
                                    Limit: ${formatRupiah(event.budget_limit)} 
                                    <i class="fa-solid fa-pen ml-1 opacity-0 group-hover:opacity-100"></i>
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 h-2 rounded">
                                <div class="${barColor} h-2 rounded" style="width: ${percentage}%"></div>
                            </div>
                            ${used > event.budget_limit ? '<div class="text-[10px] text-red-500 font-bold mt-1">OVERBUDGET!</div>' : ''}
                        </div>
                    `;
                } else {
                    budgetDisplay = `
                        <button onclick="updateEventBudget(${event.id}, '${event.name}', 0)" 
                                class="text-xs text-blue-500 underline flex items-center hover:text-blue-700">
                            <i class="fa-solid fa-calculator mr-1"></i> Set Budget
                        </button>
                    `;
                }

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 align-top">${event.region}</td>
                        <td class="p-3 align-top font-bold text-blue-900">${event.name}</td>
                        <td class="p-3 align-top text-center text-xs">${status}</td>
                        <td class="p-3 align-top">${budgetDisplay}</td>
                        <td class="p-3 align-top text-center">
                            <div class="flex flex-col gap-1">${statusButton}</div>
                        </td>
                    </tr>
                `;
            });
        }

        async function toggleEventStatus(eventId, newStatus) {
            showLoading(true);
            try {
                const { error } = await supabase
                    .from('events')
                    .update({ status: newStatus })
                    .eq('id', eventId);

                if (error) throw error;

                await fetchEvents();
                updateEventBudgetDetail();
                Swal.fire('Berhasil', `Status acara berhasil diupdate`, 'success');
            } catch (error) {
                Swal.fire('Error', `Gagal update status: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- EVENT BUDGET DETAIL ---
        function updateEventBudgetDetail() {
            const selectedRegion = document.getElementById('region-selector')?.value || 'all';
            const container = document.getElementById('event-budget-list');
            
            if (!container) return;
            container.innerHTML = '';

            // Filter events by selected region
            let filteredEvents = eventsList;
            if (selectedRegion !== 'all') {
                filteredEvents = eventsList.filter(event => event.region === selectedRegion);
            }

            // Calculate usage for each event
            const usageMap = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (t.event_name) {
                        usageMap[t.event_name] = (usageMap[t.event_name] || 0) + t.amount;
                    }
                });

            if (filteredEvents.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada acara untuk regional yang dipilih.</p>';
                return;
            }

            filteredEvents.forEach(event => {
                const used = usageMap[event.name] || 0;
                const limit = event.budget_limit || 0;
                const percentage = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
                
                // Determine status
                let statusClass = 'healthy';
                let statusText = 'Aman';
                let statusIcon = '✅';
                
                if (limit > 0) {
                    if (used > limit) {
                        statusClass = 'overbudget';
                        statusText = 'OVERBUDGET!';
                        statusIcon = '❌';
                    } else if (percentage >= 80) {
                        statusClass = 'nearly-over';
                        statusText = 'Hampir Overbudget';
                        statusIcon = '⚠️';
                    }
                } else {
                    statusText = 'Tidak ada limit';
                    statusIcon = 'ℹ️';
                }

                container.innerHTML += `
                    <div class="budget-card ${statusClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800">${event.name}</h4>
                                <p class="text-sm text-gray-600">${event.region}</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-block px-2 py-1 text-xs font-bold rounded ${
                                    statusClass === 'overbudget' ? 'bg-red-100 text-red-800' : 
                                    statusClass === 'nearly-over' ? 'bg-orange-100 text-orange-800' : 
                                    'bg-green-100 text-green-800'
                                }">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <p class="text-xs text-gray-500">Digunakan</p>
                                <p class="font-bold ${used > limit && limit > 0 ? 'text-red-600' : 'text-gray-800'}">
                                    ${formatRupiah(used)}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Budget Limit</p>
                                <p class="font-bold text-gray-800">${limit > 0 ? formatRupiah(limit) : 'Tidak Terbatas'}</p>
                            </div>
                        </div>
                        
                        ${limit > 0 ? `
                        <div class="mb-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-600">Progress: ${percentage.toFixed(1)}%</span>
                                <span class="text-gray-600">${formatRupiah(used)} / ${formatRupiah(limit)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${
                                    percentage >= 100 ? 'bg-red-600' : 
                                    percentage >= 80 ? 'bg-orange-500' : 
                                    'bg-green-600'
                                }" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>Status: ${event.status === 'active' ? 'Aktif' : 'Arsip'}</span>
                            <button onclick="updateEventBudget(${event.id}, '${event.name}', ${event.budget_limit})" 
                                    class="text-blue-600 hover:text-blue-800 flex items-center">
                                <i class="fa-solid fa-pen mr-1"></i>Edit Budget
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // --- TRANSACTIONS ---
        async function fetchTransactions() {
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                transactions = data || []; 
                applyFilter();
                updateEventBudgetDetail();
            } catch (error) {
                console.error('Error fetching transactions:', error);
            }
        }

        async function handleTransactionSubmit(event) {
            event.preventDefault();
            showLoading(true);

            const formData = {
                id: document.getElementById('t-id').value,
                type: document.getElementById('t-type').value,
                region: document.getElementById('t-region').value,
                event_name: document.getElementById('t-event-select').value,
                amount: parseFloat(document.getElementById('t-amount').value),
                category: document.getElementById('t-category').value,
                description: document.getElementById('t-desc').value,
                date: document.getElementById('t-date').value
            };

            // Validation
            if (!formData.region || !formData.event_name || !formData.amount || !formData.category) {
                showLoading(false);
                Swal.fire('Error', 'Semua field wajib diisi', 'error');
                return;
            }

            try {
                // Budget checks for expenses
                if (formData.type === 'expense' && !isEditing) {
                    // Regional budget check
                    const regionData = regionsData.find(r => r.name === formData.region);
                    if (regionData && regionData.budget_limit > 0) {
                        const currentExpense = transactions
                            .filter(t => t.region === formData.region && t.type === 'expense')
                            .reduce((sum, t) => sum + t.amount, 0);
                        
                        if (currentExpense + formData.amount > regionData.budget_limit) {
                            showLoading(false);
                            const { isConfirmed } = await Swal.fire({
                                title: 'OVERBUDGET REGIONAL!',
                                html: `Limit Regional: ${formatRupiah(regionData.budget_limit)}<br>
                                       Total akan menjadi: ${formatRupiah(currentExpense + formData.amount)}`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Lanjutkan',
                                cancelButtonText: 'Batal'
                            });
                            
                            if (!isConfirmed) return;
                            showLoading(true);
                        }
                    }

                    // Event budget check (skip for "Operasional Rutin")
                    if (formData.event_name !== 'Operasional Rutin') {
                        const eventData = eventsList.find(e => e.name === formData.event_name && e.region === formData.region);
                        if (eventData && eventData.budget_limit > 0) {
                            const eventExpense = transactions
                                .filter(t => t.event_name === formData.event_name && t.region === formData.region && t.type === 'expense')
                                .reduce((sum, t) => sum + t.amount, 0);
                            
                            if (eventExpense + formData.amount > eventData.budget_limit) {
                                showLoading(false);
                                const { isConfirmed } = await Swal.fire({
                                    title: 'OVERBUDGET ACARA!',
                                    html: `Limit Acara "${formData.event_name}": ${formatRupiah(eventData.budget_limit)}<br>
                                           Total akan menjadi: ${formatRupiah(eventExpense + formData.amount)}`,
                                    icon: 'error',
                                    showCancelButton: true,
                                    confirmButtonText: 'Paksa Simpan',
                                    cancelButtonText: 'Batal'
                                });
                                
                                if (!isConfirmed) return;
                                showLoading(true);
                            }
                        }
                    }
                }

                // Handle file upload if exists
                let proofUrl = null;
                const fileInput = document.getElementById('t-proof');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `${Date.now()}_${file.name}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('proofs')
                        .upload(fileName, file);
                    
                    if (!uploadError) {
                        const { data: urlData } = supabase.storage
                            .from('proofs')
                            .getPublicUrl(fileName);
                        proofUrl = urlData.publicUrl;
                    }
                }

                // Prepare payload
                const payload = {
                    type: formData.type,
                    region: formData.region,
                    event_name: formData.event_name,
                    category: formData.category,
                    amount: formData.amount,
                    description: formData.description,
                    created_at: new Date(formData.date).toISOString(),
                    ...(proofUrl && { proof_url: proofUrl })
                };

                // Save to database
                let result;
                if (isEditing && formData.id) {
                    result = await supabase
                        .from('transactions')
                        .update(payload)
                        .eq('id', formData.id);
                } else {
                    result = await supabase
                        .from('transactions')
                        .insert([payload]);
                }

                if (result.error) throw result.error;

                // Success
                resetForm();
                await fetchTransactions();
                Swal.fire('Berhasil', 'Transaksi berhasil disimpan', 'success');

            } catch (error) {
                console.error('Transaction error:', error);
                Swal.fire('Error', `Gagal menyimpan transaksi: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            isEditing = true;
            showSection('input');

            // Fill form with transaction data
            document.getElementById('t-id').value = transaction.id;
            document.getElementById('t-region').value = transaction.region;
            loadEventsForRegion(transaction.region, transaction.event_name);
            document.getElementById('t-type').value = transaction.type;
            document.getElementById('t-amount').value = transaction.amount;
            document.getElementById('t-category').value = transaction.category || '';
            document.getElementById('t-desc').value = transaction.description || '';
            document.getElementById('t-date').value = new Date(transaction.created_at).toISOString().split('T')[0];
            document.getElementById('keep-context').checked = false;

            // Show current proof if exists
            const currentProof = document.getElementById('current-proof');
            const currentProofLink = document.getElementById('current-proof-link');
            if (transaction.proof_url) {
                currentProof.classList.remove('hidden');
                currentProofLink.href = transaction.proof_url;
            } else {
                currentProof.classList.add('hidden');
            }
        }

        async function deleteTransaction(transactionId) {
            const { isConfirmed } = await Swal.fire({
                title: 'Hapus Transaksi?',
                text: 'Transaksi akan dihapus permanen',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Hapus',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                showLoading(true);
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', transactionId);

                    if (error) throw error;

                    await fetchTransactions();
                    Swal.fire('Berhasil', 'Transaksi berhasil dihapus', 'success');
                } catch (error) {
                    Swal.fire('Error', `Gagal menghapus transaksi: ${error.message}`, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function resetForm(fullReset = false) {
            const keepContext = document.getElementById('keep-context').checked;
            const currentRegion = document.getElementById('t-region').value;
            const currentEvent = document.getElementById('t-event-select').value;
            const currentDate = document.getElementById('t-date').value;

            document.getElementById('transaction-form').reset();
            isEditing = false;
            document.getElementById('t-id').value = '';
            document.getElementById('current-proof').classList.add('hidden');

            if (keepContext && !fullReset) {
                document.getElementById('t-region').value = currentRegion;
                loadEventsForRegion(currentRegion, currentEvent);
                document.getElementById('t-date').value = currentDate;
                document.getElementById('keep-context').checked = true;
            } else {
                document.getElementById('t-date').valueAsDate = new Date();
            }
        }

        // --- CHARTS & FILTERS ---
        function handleRegionFilterChange() {
            currentRegionFilter = document.getElementById('dashboard-filter-region').value;
            currentEventFilter = 'all';
            applyFilter();
        }

        function updateBudgetOverview() {
            const container = document.getElementById('budget-bars');
            if (!container) return;

            container.innerHTML = '';

            // Calculate expenses per region
            const expenseMap = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expenseMap[t.region] = (expenseMap[t.region] || 0) + t.amount;
                });

            let hasBudget = false;

            regionsData.forEach(region => {
                if (region.budget_limit > 0) {
                    hasBudget = true;
                    const used = expenseMap[region.name] || 0;
                    const percentage = Math.min((used / region.budget_limit) * 100, 100);
                    const isOver = used > region.budget_limit;
                    const barColor = isOver ? 'bg-red-600' : (percentage > 80 ? 'bg-orange-500' : 'bg-blue-600');
                    const textColor = isOver ? 'text-red-600' : 'text-gray-600';

                    container.innerHTML += `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold">${region.name}</span>
                                <span class="${textColor}">
                                    ${formatRupiah(used)} / ${formatRupiah(region.budget_limit)}
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 h-2 rounded">
                                <div class="${barColor} h-2 rounded" style="width: ${percentage}%"></div>
                            </div>
                            ${isOver ? '<div class="text-[10px] text-red-500 font-bold mt-0.5">OVERBUDGET!</div>' : ''}
                        </div>
                    `;
                }
            });

            if (!hasBudget) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">Belum ada batas anggaran regional yang diatur.</p>';
            }
        }

        function applyFilter() {
            const regionFilter = document.getElementById('dashboard-filter-region').value;
            const eventFilter = document.getElementById('dashboard-filter-event');
            
            let filteredData = transactions;

            // Apply region filter
            if (regionFilter !== 'all') {
                filteredData = filteredData.filter(t => t.region === regionFilter);
                eventFilter.disabled = false;
                
                // Update event filter options
                const eventsInRegion = [...new Set([
                    ...eventsList.filter(e => e.region === regionFilter).map(e => e.name),
                    ...transactions.filter(t => t.region === regionFilter).map(t => t.event_name)
                ])].filter(Boolean);
                
                const currentEventValue = eventFilter.value;
                eventFilter.innerHTML = '<option value="all">Semua Acara</option>';
                eventsInRegion.forEach(event => {
                    eventFilter.add(new Option(event, event));
                });
                
                if (eventsInRegion.includes(currentEventValue)) {
                    eventFilter.value = currentEventValue;
                } else {
                    eventFilter.value = 'all';
                }
            } else {
                eventFilter.disabled = true;
                eventFilter.innerHTML = '<option value="all">Semua Acara</option>';
            }

            // Apply event filter
            if (eventFilter.value !== 'all') {
                filteredData = filteredData.filter(t => t.event_name === eventFilter.value);
            }

            // Update budget overview visibility
            const budgetOverview = document.getElementById('budget-overview');
            if (regionFilter === 'all') {
                budgetOverview.classList.remove('hidden');
                updateBudgetOverview();
            } else {
                budgetOverview.classList.add('hidden');
            }

            updateDashboard(filteredData);
            renderTransactionList(filteredData);
            updateCharts(filteredData);
        }

        function updateDashboard(filteredData) {
            const income = filteredData
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const expense = filteredData
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = income - expense;

            document.getElementById('total-income').textContent = formatRupiah(income);
            document.getElementById('total-expense').textContent = formatRupiah(expense);
            document.getElementById('net-balance').textContent = formatRupiah(balance);
        }

        function renderTransactionList(filteredData) {
            const tbody = document.getElementById('transaction-list');
            if (!tbody) return;

            tbody.innerHTML = '';

            filteredData.slice(0, 50).forEach(transaction => {
                const amountClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                const amountSign = transaction.type === 'income' ? '+' : '-';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3 text-xs">${new Date(transaction.created_at).toLocaleDateString('id-ID')}</td>
                        <td class="p-3">
                            <div class="font-bold text-sm">${transaction.region}</div>
                            <div class="text-xs text-gray-600">${transaction.event_name || '-'}</div>
                        </td>
                        <td class="p-3 text-xs bg-gray-50">${transaction.category || ''}</td>
                        <td class="p-3 text-right text-sm font-bold ${amountClass}">
                            ${amountSign} ${formatRupiah(transaction.amount)}
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="editTransaction(${transaction.id})" class="text-yellow-600 hover:text-yellow-800 mx-1">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="deleteTransaction(${transaction.id})" class="text-red-500 hover:text-red-700 mx-1">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateCharts(filteredData) {
            // Cash Flow Chart (Monthly)
            const monthlyData = {};
            filteredData.forEach(transaction => {
                const month = new Date(transaction.created_at).toLocaleDateString('id-ID', { 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }
                
                if (transaction.type === 'income') {
                    monthlyData[month].income += transaction.amount;
                } else {
                    monthlyData[month].expense += transaction.amount;
                }
            });

            const months = Object.keys(monthlyData);
            const incomeData = months.map(month => monthlyData[month].income);
            const expenseData = months.map(month => monthlyData[month].expense);

            if (cashFlowChartInstance) {
                cashFlowChartInstance.destroy();
            }

            const cashFlowCtx = document.getElementById('cashFlowChart');
            if (cashFlowCtx) {
                cashFlowChartInstance = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                data: incomeData,
                                backgroundColor: '#16a34a'
                            },
                            {
                                label: 'Pengeluaran',
                                data: expenseData,
                                backgroundColor: '#dc2626'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Breakdown Chart
            const breakdownData = {};
            const breakdownTitle = document.getElementById('breakdown-title');
            
            if (currentRegionFilter === 'all') {
                breakdownTitle.textContent = 'Pemasukan per Regional';
                filteredData
                    .filter(t => t.type === 'income')
                    .forEach(t => {
                        breakdownData[t.region] = (breakdownData[t.region] || 0) + t.amount;
                    });
            } else {
                breakdownTitle.textContent = 'Pengeluaran per Kategori';
                filteredData
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        breakdownData[t.category] = (breakdownData[t.category] || 0) + t.amount;
                    });
            }

            if (breakdownChartInstance) {
                breakdownChartInstance.destroy();
            }

            const breakdownCtx = document.getElementById('breakdownChart');
            if (breakdownCtx && Object.keys(breakdownData).length > 0) {
                breakdownChartInstance = new Chart(breakdownCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(breakdownData),
                        datasets: [{
                            data: Object.values(breakdownData),
                            backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        // --- UTILITY FUNCTIONS ---
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.toggle('hidden', !show);
            }
        }

        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }

        function viewProof(url) {
            const modalImg = document.getElementById('modal-img');
            if (modalImg) {
                modalImg.src = url;
                document.getElementById('image-modal').classList.remove('hidden');
            }
        }

        function exportToExcel() {
            let dataToExport = transactions;
            
            if (currentRegionFilter !== 'all') {
                dataToExport = dataToExport.filter(t => t.region === currentRegionFilter);
            }

            const worksheet = XLSX.utils.json_to_sheet(dataToExport.map(t => ({
                Tanggal: new Date(t.created_at).toLocaleDateString('id-ID'),
                Regional: t.region,
                Acara: t.event_name || '',
                Kategori: t.category || '',
                Tipe: t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                Jumlah: t.amount,
                Keterangan: t.description || '',
                'Bukti URL': t.proof_url || ''
            })));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan Keuangan');
            
            const fileName = `Laporan_Keuangan_${currentRegionFilter}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }
    </script>
</body>
</html>
