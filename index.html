<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan NGO - Event Budgeting Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af', 
                        secondary: '#0f172a',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col md:flex-row">

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-secondary text-white flex-shrink-0 fixed md:static bottom-0 z-40 md:h-screen shadow-xl flex flex-col justify-between">
        <div>
            <div class="p-6 hidden md:block">
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-hand-holding-heart mr-2"></i>NGO Finance</h1>
                <p class="text-xs text-gray-400 mt-1">v9.1 Event Budget Fixed</p>
            </div>
            <nav class="md:mt-4 flex md:flex-col overflow-x-auto md:overflow-visible w-full bg-secondary">
                <a href="#" onclick="showSection('dashboard')" class="nav-item active-nav block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-primary bg-gray-800" id="nav-dashboard">
                    <i class="fa-solid fa-chart-line w-6"></i> Dashboard
                </a>
                <a href="#" onclick="showSection('input')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-input">
                    <i class="fa-solid fa-plus-circle w-6"></i> Transaksi
                </a>
                <a href="#" onclick="showSection('events')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-events">
                    <i class="fa-solid fa-calendar-check w-6"></i> Data Acara
                </a>
                <a href="#" onclick="showSection('regions')" class="nav-item block py-3 px-6 hover:bg-gray-700 transition border-l-4 border-transparent" id="nav-regions">
                    <i class="fa-solid fa-wallet w-6"></i> Budget Regional
                </a>
            </nav>
        </div>
        
        <div class="p-4 bg-gray-800 md:block hidden">
            <button onclick="checkDatabaseHealth(true)" class="flex items-center space-x-2 text-xs text-gray-400 hover:text-white transition w-full">
                <div id="db-status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span id="db-status-text">Cek Koneksi Database</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto mb-16 md:mb-0">
        
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
            <div class="bg-white p-5 rounded-lg shadow-lg flex items-center">
                <i class="fa-solid fa-spinner fa-spin text-primary text-2xl mr-3"></i>
                <span>Memproses...</span>
            </div>
        </div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="content-section space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-lg shadow-sm">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-sm text-gray-500">Status Keuangan & Anggaran</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                    <select id="dashboard-filter-region" onchange="handleRegionFilterChange()" class="filter-select"><option value="all">Semua Regional</option></select>
                    <select id="dashboard-filter-event" onchange="applyFilter()" class="filter-select disabled:bg-gray-100" disabled><option value="all">Semua Acara</option></select>
                    <div class="flex gap-2">
                        <button onclick="fetchAllData()" class="btn-icon"><i class="fa-solid fa-arrows-rotate"></i></button>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-sm font-bold"><i class="fa-solid fa-file-excel mr-2"></i>Export</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stats-card border-green-500"><div class="title">Total Pemasukan</div><div class="value text-green-600" id="total-income">Rp 0</div></div>
                <div class="stats-card border-red-500"><div class="title">Total Pengeluaran</div><div class="value text-red-600" id="total-expense">Rp 0</div></div>
                <div class="stats-card border-blue-500"><div class="title">Saldo Akhir</div><div class="value text-blue-800" id="net-balance">Rp 0</div></div>
            </div>

            <!-- Budget Overview Container -->
            <div id="budget-overview" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Status Anggaran Regional</h3>
                <div id="budget-bars" class="space-y-4"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Arus Kas Bulanan</h3><div class="relative h-[280px]"><canvas id="cashFlowChart"></canvas></div></div>
                <div class="chart-container"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2" id="breakdown-title">Distribusi</h3><div class="relative h-[280px] flex justify-center"><canvas id="breakdownChart"></canvas></div></div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b bg-gray-50 font-bold text-gray-700">Riwayat Transaksi</div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-100 text-gray-600"><tr><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Regional / Acara</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3 text-right">Jumlah</th><th class="px-4 py-3 text-center">Aksi</th></tr></thead><tbody id="transaction-list" class="divide-y divide-gray-200"></tbody></table></div>
            </div>
        </section>

        <!-- INPUT SECTION -->
        <section id="input" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Input Transaksi</h2>
            <div class="bg-white p-6 rounded-lg shadow max-w-4xl mx-auto border-t-4 border-primary">
                <form id="transaction-form" onsubmit="handleTransactionSubmit(event)">
                    <input type="hidden" id="t-id">
                    <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 mb-6 relative">
                        <div class="absolute top-4 right-4 flex items-center bg-white px-3 py-1 rounded-full shadow-sm border border-blue-100">
                            <input type="checkbox" id="keep-context" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                            <label for="keep-context" class="ml-2 text-xs font-bold text-blue-700 cursor-pointer select-none">Input Beruntun</label>
                        </div>
                        <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-4">1. Konteks</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="label-text">Regional</label>
                                <div class="flex gap-2"><select id="t-region" class="input-field bg-white" onchange="loadEventsForRegion(this.value)" required></select><button type="button" onclick="quickAddRegion()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Tambah Regional"><i class="fa-solid fa-plus"></i></button></div>
                            </div>
                            <div>
                                <label class="label-text">Acara (Program)</label>
                                <div class="flex gap-2"><select id="t-event-select" class="input-field bg-white" required><option value="">-- Pilih Regional Dahulu --</option></select><button type="button" onclick="quickAddEvent()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Buat Acara Baru"><i class="fa-solid fa-plus"></i></button></div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3 px-1">2. Detail</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label-text">Jenis</label><select id="t-type" class="input-field font-bold" required><option value="expense" class="text-red-600">Pengeluaran</option><option value="income" class="text-green-600">Pemasukan</option></select></div>
                        <div class="md:col-span-2"><label class="label-text">Kategori</label><input type="text" id="t-category" list="cat-list" class="input-field" required><datalist id="cat-list"><option value="Konsumsi"><option value="Transport"><option value="Donasi"></datalist></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="label-text">Jumlah (Rp)</label><input type="number" id="t-amount" min="1" class="input-field font-bold" required></div>
                        <div><label class="label-text">Tanggal</label><input type="date" id="t-date" class="input-field" required></div>
                    </div>
                    <div class="mb-4"><label class="label-text">Ket</label><textarea id="t-desc" rows="2" class="input-field"></textarea></div>
                    <div class="mb-6"><label class="label-text">Bukti</label><input type="file" id="t-proof" class="input-field p-2 bg-gray-50" accept="image/*"><div id="current-proof" class="mt-2 text-xs hidden"><a href="#" target="_blank" id="current-proof-link" class="text-blue-600">Lihat bukti</a></div></div>
                    <div class="flex gap-3"><button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded shadow-lg">Simpan</button><button type="button" onclick="resetForm(true)" class="px-5 bg-gray-200 rounded">Reset</button></div>
                </form>
            </div>
        </section>

        <!-- EVENTS -->
        <section id="events" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Manajemen Acara & Budget</h2>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Daftar Acara & Realisasi Anggaran</h3>
                    <button onclick="fetchEvents()" class="bg-gray-100 px-3 py-1 rounded text-sm"><i class="fa-solid fa-sync"></i> Refresh</button>
                </div>
                
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="p-3">Regional</th>
                                <th class="p-3">Nama Acara</th>
                                <th class="p-3 text-center">Status</th>
                                <th class="p-3 w-1/3">Penggunaan Anggaran</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-event-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REGIONS -->
        <section id="regions" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Regional & Anggaran</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit border-t-4 border-green-600"><h3 class="font-bold mb-4">Tambah Regional</h3><div class="space-y-4"><div><label class="label-text">Nama</label><input type="text" id="new-region-name" class="input-field"></div><div><label class="label-text">Budget (0 = Unlimited)</label><input type="number" id="new-region-budget" class="input-field" value="0"></div><button onclick="addRegion()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Simpan</button></div></div>
                <div class="bg-white p-6 rounded-lg shadow"><div class="flex justify-between mb-3"><h3 class="font-bold">List Regional</h3><button onclick="fetchRegions()" class="text-blue-600"><i class="fa-solid fa-refresh"></i></button></div><div class="overflow-y-auto max-h-[600px]"><ul id="regions-list" class="divide-y divide-gray-100"></ul></div></div>
            </div>
        </section>

    </main>

    <!-- Modals & Styles -->
    <div id="image-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4" onclick="closeModal()"><img id="modal-img" src="" class="max-h-screen max-w-full rounded shadow-lg"><button class="absolute top-5 right-5 text-white text-3xl">&times;</button></div>
    <div id="sql-modal" class="hidden fixed inset-0 z-[70] bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
            <h3 class="text-xl font-bold text-red-600 mb-2">Setup Database</h3>
            <p class="text-sm text-gray-600 mb-4">Jalankan SQL ini di Supabase:</p>
            <div class="bg-gray-100 p-4 rounded text-xs font-mono overflow-auto max-h-60 mb-4 select-all" id="sql-code">
CREATE TABLE IF NOT EXISTS public.regions (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL, name text NOT NULL UNIQUE, budget_limit numeric DEFAULT 0);
CREATE TABLE IF NOT EXISTS public.events (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL, region text NOT NULL, name text NOT NULL, status text DEFAULT 'active', budget_limit numeric DEFAULT 0);
CREATE TABLE IF NOT EXISTS public.transactions (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL, amount numeric NOT NULL, type text NOT NULL, region text NOT NULL, event_name text, category text, description text, proof_url text);
ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY; CREATE POLICY "All" ON public.transactions FOR ALL USING (true) WITH CHECK (true);
ALTER TABLE public.regions ENABLE ROW LEVEL SECURITY; CREATE POLICY "All" ON public.regions FOR ALL USING (true) WITH CHECK (true);
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY; CREATE POLICY "All" ON public.events FOR ALL USING (true) WITH CHECK (true);
            </div>
            <button onclick="document.getElementById('sql-modal').classList.add('hidden')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded w-full">Tutup</button>
        </div>
    </div>
    <style>.input-field {width:100%;padding:0.6rem;border:1px solid #d1d5db;border-radius:0.375rem;outline:none}.input-field:focus{border-color:#1e40af;box-shadow:0 0 0 3px rgba(30,64,175,0.1)}.filter-select{padding:0.5rem 1rem;border:1px solid #e5e7eb;border-radius:0.375rem;outline:none}.btn-icon{padding:0.5rem 1rem;background:#fff;border:1px solid #e5e7eb;border-radius:0.375rem}.stats-card{background:white;padding:1.25rem;border-radius:0.5rem;border-left-width:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.chart-container{background:white;padding:1rem;border-radius:0.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);height:280px;position:relative}</style>

    <script>
        const SUPABASE_URL = 'https://ljhcszzmuaourbwwozmf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let regionsData=[], transactions=[], eventsList=[], currentRegionFilter='all', currentEventFilter='all', isEditing=false, cashFlowChartInstance=null, breakdownChartInstance=null;

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('t-date').valueAsDate = new Date();
            fetchAllData(); checkDatabaseHealth();
        });

        async function checkDatabaseHealth(manual = false) {
            const dot = document.getElementById('db-status-dot');
            const { error } = await supabase.from('regions').select('count', { count: 'exact', head: true });
            if (error && (error.code === '42P01' || error.code === 'PGRST205')) {
                dot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                document.getElementById('db-status-text').innerText = "DB Error (Klik)";
                if(!window.hasShownSqlModal || manual) document.getElementById('sql-modal').classList.remove('hidden');
                window.hasShownSqlModal = true;
            } else {
                dot.className = "w-2 h-2 rounded-full bg-green-500";
                document.getElementById('db-status-text').innerText = "DB OK";
                if(manual) Swal.fire('Koneksi Bagus', 'Semua tabel ditemukan.', 'success');
            }
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('bg-gray-800','border-primary'); el.classList.add('border-transparent'); });
            document.getElementById('nav-'+id).classList.add('bg-gray-800','border-primary');
            document.getElementById('nav-'+id).classList.remove('border-transparent');
            if(['dashboard','events','regions'].includes(id)) fetchAllData();
        }

        async function fetchAllData() {
            showLoading(true);
            try { await Promise.all([fetchRegions(), fetchTransactions(), fetchEvents()]); } catch(e) { console.error(e); } finally { showLoading(false); }
        }

        // --- REGIONS ---
        async function fetchRegions() {
            const { data } = await supabase.from('regions').select('*').order('name');
            regionsData = data || []; renderRegionsUI(); updateBudgetOverview();
        }
        async function addRegion() {
            const n=document.getElementById('new-region-name').value.trim(), b=parseFloat(document.getElementById('new-region-budget').value)||0;
            if(!n)return; showLoading(true);
            const {error} = await supabase.from('regions').upsert({name:n, budget_limit:b}, {onConflict:'name'});
            showLoading(false);
            if(error) Swal.fire('Error', error.message, 'error'); else { document.getElementById('new-region-name').value=''; fetchRegions(); Swal.fire('Sukses','Regional disimpan','success'); }
        }
        async function quickAddRegion() {
            const {value:v} = await Swal.fire({title:'Tambah Regional', html:'<input id="q-reg" class="swal2-input" placeholder="Nama">', preConfirm:()=>document.getElementById('q-reg').value});
            if(v) { showLoading(true); const {error} = await supabase.from('regions').insert([{name:v}]); showLoading(false); if(error) Swal.fire('Error', error.message, 'error'); else { await fetchRegions(); document.getElementById('t-region').value=v; loadEventsForRegion(v); Swal.fire('Sukses','','success'); } }
        }
        async function deleteRegion(n) {
            if((await Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true})).isConfirmed) {
                showLoading(true); await supabase.from('regions').delete().eq('name',n); showLoading(false); fetchRegions();
            }
        }
        function renderRegionsUI() {
            const lst=document.getElementById('regions-list'), sel=document.getElementById('t-region'), fil=document.getElementById('dashboard-filter-region');
            lst.innerHTML=''; sel.innerHTML='<option value="">-- Pilih --</option>'; fil.innerHTML='<option value="all">Semua Regional</option>';
            const currSel=sel.value, currFil=fil.value;
            regionsData.forEach(r => {
                lst.innerHTML += `<li class="py-2 border-b flex justify-between"><div><b>${r.name}</b> <span class="text-xs bg-gray-100 px-1 rounded">Limit: ${formatRupiah(r.budget_limit)}</span></div><button onclick="deleteRegion('${r.name}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></li>`;
                sel.add(new Option(r.name,r.name)); fil.add(new Option(r.name,r.name));
            });
            if(regionsData.some(r=>r.name===currSel)) sel.value=currSel;
            if(currFil==='all'||regionsData.some(r=>r.name===currFil)) fil.value=currFil; else fil.value='all';
        }

        // --- EVENTS & EVENT BUDGET ---
        async function fetchEvents() {
            const {data} = await supabase.from('events').select('*').order('name');
            eventsList = data||[]; renderMasterEventList(); 
            const r=document.getElementById('t-region').value; if(r) loadEventsForRegion(r);
        }
        function loadEventsForRegion(r, selEv=null) {
            const s=document.getElementById('t-event-select'); s.innerHTML='';
            if(!r){ s.add(new Option('-- Pilih Regional --','')); return; }
            s.add(new Option('-- Pilih Acara --',''));
            eventsList.filter(e=>e.region===r && e.status!=='completed').forEach(e=>s.add(new Option(e.name,e.name)));
            s.add(new Option('Operasional Rutin','Operasional Rutin'));
            if(selEv) s.value=selEv;
        }
        async function quickAddEvent() {
            const r=document.getElementById('t-region').value; if(!r) return Swal.fire('Pilih Regional','','info');
            const {value:vals} = await Swal.fire({
                title: 'Buat Acara Baru',
                html: '<input id="swal-ev-name" class="swal2-input" placeholder="Nama Acara"><input id="swal-ev-budget" type="number" class="swal2-input" placeholder="Budget Limit (Opsional)">',
                preConfirm: () => [document.getElementById('swal-ev-name').value, document.getElementById('swal-ev-budget').value]
            });
            if(vals && vals[0]) {
                const name = vals[0], limit = parseFloat(vals[1]) || 0;
                await supabase.from('events').insert([{region:r, name:name, budget_limit:limit}]);
                await fetchEvents(); loadEventsForRegion(r,name); Swal.fire('Sukses','Acara dibuat','success');
            }
        }
        async function updateEventBudget(id, name, oldBudget) {
            const {value:newBudget} = await Swal.fire({title:`Budget: ${name}`, input:'number', inputValue:oldBudget, inputLabel:'Masukkan 0 untuk tanpa batas'});
            if(newBudget !== null) {
                showLoading(true);
                await supabase.from('events').update({budget_limit: parseFloat(newBudget)}).eq('id',id);
                fetchEvents(); showLoading(false);
            }
        }
        function renderMasterEventList() {
            const tb=document.getElementById('master-event-list'); tb.innerHTML='';
            if(!eventsList.length) tb.innerHTML='<tr><td colspan="5" class="p-4 text-center">Kosong</td></tr>';
            
            // Calculate usage per event
            const usageMap = {};
            transactions.filter(t=>t.type==='expense').forEach(t=> {
                if(t.event_name) usageMap[t.event_name] = (usageMap[t.event_name]||0) + t.amount;
            });

            eventsList.forEach(e=>{
                const st = e.status!=='completed' ? '<span class="text-green-600 font-bold">Aktif</span>' : '<span class="text-gray-400">Arsip</span>';
                const btn = e.status!=='completed' ? `<button onclick="togEv(${e.id},'completed')" class="text-xs border p-1 rounded hover:bg-gray-100">Arsipkan</button>` : `<button onclick="togEv(${e.id},'active')" class="text-xs text-blue-600 border p-1 rounded hover:bg-blue-50">Aktifkan</button>`;
                
                // Budget Bar
                let budgetBar = '<span class="text-xs text-gray-400">Tidak ada limit</span>';
                if(e.budget_limit > 0) {
                    const used = usageMap[e.name] || 0;
                    const pct = Math.min((used/e.budget_limit)*100, 100);
                    const col = used > e.budget_limit ? 'bg-red-600' : (pct>80?'bg-orange-500':'bg-blue-600');
                    budgetBar = `
                        <div class="cursor-pointer" onclick="updateEventBudget(${e.id}, '${e.name}', ${e.budget_limit})" title="Klik untuk edit budget">
                            <div class="flex justify-between text-xs mb-1">
                                <span>${formatRupiah(used)}</span>
                                <span class="font-bold text-gray-600">Limit: ${formatRupiah(e.budget_limit)}</span>
                            </div>
                            <div class="w-full bg-gray-200 h-2 rounded"><div class="${col} h-2 rounded" style="width:${pct}%"></div></div>
                            ${used > e.budget_limit ? '<div class="text-[10px] text-red-500 font-bold">Overbudget!</div>' : ''}
                        </div>
                    `;
                } else {
                    budgetBar = `<button onclick="updateEventBudget(${e.id}, '${e.name}', 0)" class="text-xs text-blue-500 underline">Set Budget</button>`;
                }

                tb.innerHTML+=`
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 align-top">${e.region}</td>
                        <td class="p-3 align-top font-bold text-blue-900">${e.name}</td>
                        <td class="p-3 align-top text-center text-xs">${st}</td>
                        <td class="p-3 align-top">${budgetBar}</td>
                        <td class="p-3 align-top text-center gap-1 flex flex-col">${btn}</td>
                    </tr>`;
            });
        }
        async function togEv(id,s){ await supabase.from('events').update({status:s}).eq('id',id); fetchEvents(); }

        // --- TRANSACTIONS & DOUBLE CHECK ---
        async function fetchTransactions() {
            const {data,error}=await supabase.from('transactions').select('*').order('created_at',{ascending:false});
            if(!error) { transactions=data||[]; applyFilter(); }
        }
        async function handleTransactionSubmit(e) {
            e.preventDefault(); showLoading(true);
            const id=document.getElementById('t-id').value, type=document.getElementById('t-type').value, reg=document.getElementById('t-region').value, ev=document.getElementById('t-event-select').value, amt=parseFloat(document.getElementById('t-amount').value), date=document.getElementById('t-date').value;
            
            // CHECK 1: REGIONAL BUDGET
            if(type==='expense' && !isEditing) {
                const rd = regionsData.find(r=>r.name===reg);
                if(rd && rd.budget_limit > 0) {
                    const curr = transactions.filter(t=>t.region===reg && t.type==='expense').reduce((a,b)=>a+b.amount,0);
                    if(curr+amt > rd.budget_limit) {
                        showLoading(false);
                        const {isConfirmed} = await Swal.fire({title:'OVERBUDGET REGIONAL!', html:`Limit Regional: ${formatRupiah(rd.budget_limit)}<br>Akan menjadi: ${formatRupiah(curr+amt)}`, icon:'warning', showCancelButton:true, confirmButtonText:'Lanjut', confirmButtonColor:'#d33'});
                        if(!isConfirmed) return;
                        showLoading(true);
                    }
                }
                
                // CHECK 2: EVENT BUDGET
                const ed = eventsList.find(e=>e.name===ev && e.region===reg);
                if(ed && ed.budget_limit > 0) {
                    const evCurr = transactions.filter(t=>t.event_name===ev && t.type==='expense').reduce((a,b)=>a+b.amount,0);
                    if(evCurr+amt > ed.budget_limit) {
                        showLoading(false);
                        const {isConfirmed} = await Swal.fire({title:'OVERBUDGET ACARA!', html:`Limit Acara "${ev}": ${formatRupiah(ed.budget_limit)}<br>Akan menjadi: ${formatRupiah(evCurr+amt)}`, icon:'error', showCancelButton:true, confirmButtonText:'Paksa Simpan', confirmButtonColor:'#d33'});
                        if(!isConfirmed) return;
                        showLoading(true);
                    }
                }
            }

            let proofUrl = null;
            const file = document.getElementById('t-proof').files[0];
            if(file) {
                const name = `${Date.now()}_${file.name}`;
                const {error} = await supabase.storage.from('proofs').upload(name, file);
                if(!error) proofUrl = supabase.storage.from('proofs').getPublicUrl(name).data.publicUrl;
            }

            const payload = { type, region:reg, event_name:ev, category:document.getElementById('t-category').value, amount:amt, description:document.getElementById('t-desc').value, created_at:new Date(date).toISOString(), ...(proofUrl && {proof_url:proofUrl}) };
            
            if(isEditing && id) await supabase.from('transactions').update(payload).eq('id',id);
            else await supabase.from('transactions').insert([payload]);
            
            showLoading(false); resetForm(); fetchTransactions(); Swal.fire('Tersimpan','','success');
        }
        
        function editTransaction(id) {
            const t=transactions.find(x=>x.id==id); if(!t)return;
            isEditing=true; showSection('input');
            document.getElementById('t-id').value=t.id; document.getElementById('t-region').value=t.region; loadEventsForRegion(t.region, t.event_name);
            document.getElementById('t-type').value=t.type; document.getElementById('t-amount').value=t.amount; document.getElementById('t-category').value=t.category; document.getElementById('t-desc').value=t.description; document.getElementById('t-date').value=new Date(t.created_at).toISOString().split('T')[0];
            document.getElementById('keep-context').checked=false;
        }
        async function deleteTransaction(id) { if((await Swal.fire({title:'Hapus?',showCancelButton:true})).isConfirmed){ await supabase.from('transactions').delete().eq('id',id); fetchTransactions(); } }
        
        function resetForm(full=false) {
            const k=document.getElementById('keep-context').checked, r=document.getElementById('t-region').value, ev=document.getElementById('t-event-select').value, d=document.getElementById('t-date').value;
            document.getElementById('transaction-form').reset(); isEditing=false; document.getElementById('t-id').value='';
            if(k && !full) { document.getElementById('t-region').value=r; loadEventsForRegion(r,ev); document.getElementById('t-date').value=d; document.getElementById('keep-context').checked=true; }
            else document.getElementById('t-date').valueAsDate=new Date();
        }

        // CHARTS
        function handleRegionFilterChange() { currentRegionFilter=document.getElementById('dashboard-filter-region').value; currentEventFilter='all'; applyFilter(); }
        
        // FIXED: Added missing updateBudgetOverview function here
        function updateBudgetOverview() {
            const container = document.getElementById('budget-bars');
            if(!container) return;
            container.innerHTML = '';
            
            // Calculate expenses per region
            const expMap = {}; 
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expMap[t.region] = (expMap[t.region] || 0) + t.amount;
            });

            let hasBudget = false;
            regionsData.forEach(r => {
                if (r.budget_limit > 0) {
                    hasBudget = true;
                    const used = expMap[r.name] || 0;
                    const percent = Math.min((used / r.budget_limit) * 100, 100);
                    const isOver = used > r.budget_limit;
                    const barColor = isOver ? 'bg-red-600' : (percent > 80 ? 'bg-orange-500' : 'bg-blue-600');
                    const textColor = isOver ? 'text-red-600' : 'text-gray-600';

                    container.innerHTML += `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold">${r.name}</span>
                                <span class="${textColor}">${formatRupiah(used)} / ${formatRupiah(r.budget_limit)}</span>
                            </div>
                            <div class="w-full bg-gray-200 h-2 rounded">
                                <div class="${barColor} h-2 rounded" style="width: ${percent}%"></div>
                            </div>
                            ${isOver ? '<div class="text-[10px] text-red-500 font-bold mt-0.5">Overbudget!</div>' : ''}
                        </div>
                    `;
                }
            });

            if (!hasBudget) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">Belum ada batas anggaran regional yang diatur.</p>';
            }
        }

        function applyFilter() {
            const fReg=document.getElementById('dashboard-filter-region').value, fEv=document.getElementById('dashboard-filter-event');
            let data = transactions;
            
            if(fReg!=='all') {
                data = data.filter(t=>t.region===fReg);
                fEv.disabled=false;
                const evs = [...new Set([...eventsList.filter(e=>e.region===fReg).map(e=>e.name), ...transactions.filter(t=>t.region===fReg).map(t=>t.event_name)])];
                const oldVal = fEv.value; fEv.innerHTML='<option value="all">Semua Acara</option>'; evs.forEach(e=>fEv.add(new Option(e,e))); fEv.value = evs.includes(oldVal)?oldVal:'all';
            } else { fEv.disabled=true; fEv.innerHTML='<option value="all">Semua Acara</option>'; }
            
            if(fEv.value!=='all') data = data.filter(t=>t.event_name===fEv.value);
            
            // Show/Hide Budget Overview
            const budgetOverview = document.getElementById('budget-overview');
            if (currentRegionFilter === 'all') {
                budgetOverview.classList.remove('hidden');
                updateBudgetOverview(); // FIXED: Calling the now-defined function
            } else {
                budgetOverview.classList.add('hidden');
            }

            updateDashboard(data); renderTransList(data); updateCharts(data);
        }
        function updateDashboard(d) {
            let i=0,e=0; d.forEach(t=>t.type==='income'?i+=t.amount:e+=t.amount);
            document.getElementById('total-income').innerText=formatRupiah(i); document.getElementById('total-expense').innerText=formatRupiah(e); document.getElementById('net-balance').innerText=formatRupiah(i-e);
        }
        function renderTransList(d) {
            const tb=document.getElementById('transaction-list'); tb.innerHTML='';
            d.slice(0,50).forEach(t=>{
                const col=t.type==='income'?'text-green-600':'text-red-600';
                tb.innerHTML+=`<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-xs">${new Date(t.created_at).toLocaleDateString()}</td><td class="p-3"><div class="font-bold text-sm">${t.region}</div><div class="text-xs">${t.event_name||''}</div></td><td class="p-3 text-xs bg-gray-50">${t.category||''}</td><td class="p-3 text-right text-sm font-bold ${col}">${formatRupiah(t.amount)}</td><td class="p-3 text-center"><button onclick="editTransaction(${t.id})" class="text-yellow-600"><i class="fa-solid fa-pen"></i></button> <button onclick="deleteTransaction(${t.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        function updateCharts(d) {
            const m={}; d.forEach(t=>{ const k=new Date(t.created_at).toLocaleString('id',{month:'short'}); if(!m[k])m[k]={i:0,e:0}; t.type==='income'?m[k].i+=t.amount:m[k].e+=t.amount; });
            const ks=Object.keys(m);
            if(cashFlowChartInstance) cashFlowChartInstance.destroy();
            cashFlowChartInstance=new Chart(document.getElementById('cashFlowChart'),{type:'bar',data:{labels:ks,datasets:[{label:'Masuk',data:ks.map(k=>m[k].i),backgroundColor:'#16a34a'},{label:'Keluar',data:ks.map(k=>m[k].e),backgroundColor:'#dc2626'}]},options:{responsive:true,maintainAspectRatio:false}});
            
            const b={}; document.getElementById('breakdown-title').innerText = currentRegionFilter==='all'?'Pemasukan per Region':'Pengeluaran per Kategori';
            d.forEach(t=>{ if(currentRegionFilter==='all'){if(t.type==='income')b[t.region]=(b[t.region]||0)+t.amount} else {if(t.type==='expense')b[t.category]=(b[t.category]||0)+t.amount} });
            if(breakdownChartInstance) breakdownChartInstance.destroy();
            breakdownChartInstance=new Chart(document.getElementById('breakdownChart'),{type:'doughnut',data:{labels:Object.keys(b),datasets:[{data:Object.values(b),backgroundColor:['#3b82f6','#f59e0b','#10b981','#ef4444','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});
        }

        function formatRupiah(n){return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n)}
        function showLoading(b){document.getElementById('loading').classList.toggle('hidden',!b)}
        function closeModal(){document.getElementById('image-modal').classList.add('hidden')}
        function viewProof(u){document.getElementById('modal-img').src=u;document.getElementById('image-modal').classList.remove('hidden')}
        function exportToExcel(){
            let d=transactions, f=currentRegionFilter;
            if(f!=='all') d=d.filter(t=>t.region===f);
            const ws=XLSX.utils.json_to_sheet(d.map(t=>({Tanggal:t.created_at,Regional:t.region,Acara:t.event_name,Kategori:t.category,Tipe:t.type,Jumlah:t.amount,Ket:t.description})));
            const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb, `Laporan_${f}.xlsx`);
        }
    </script>
</body>
</html>
