<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan NGO</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af', // Blue 800
                        secondary: '#0f172a', // Slate 900
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col md:flex-row">

    <!-- Sidebar Navigation -->
    <aside class="w-full md:w-64 bg-secondary text-white flex-shrink-0">
        <div class="p-6">
            <h1 class="text-2xl font-bold"><i class="fa-solid fa-hand-holding-heart mr-2"></i>NGO Finance</h1>
        </div>
        <nav class="mt-4">
            <a href="#" onclick="showSection('dashboard')" class="block py-3 px-6 hover:bg-gray-700 transition nav-item active-nav border-l-4 border-primary bg-gray-800" id="nav-dashboard">
                <i class="fa-solid fa-chart-line w-6"></i> Dashboard
            </a>
            <a href="#" onclick="showSection('input')" class="block py-3 px-6 hover:bg-gray-700 transition nav-item border-l-4 border-transparent" id="nav-input">
                <i class="fa-solid fa-plus-circle w-6"></i> Catat Transaksi
            </a>
            <a href="#" onclick="showSection('regions')" class="block py-3 px-6 hover:bg-gray-700 transition nav-item border-l-4 border-transparent" id="nav-regions">
                <i class="fa-solid fa-map-location-dot w-6"></i> Kelola Regional
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white p-5 rounded-lg shadow-lg flex items-center">
                <i class="fa-solid fa-spinner fa-spin text-primary text-2xl mr-3"></i>
                <span>Memproses data...</span>
            </div>
        </div>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="content-section space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard Keuangan</h2>
                    <p class="text-sm text-gray-500 mt-1">Pantau arus kas per regional dan acara</p>
                </div>
                
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                    <!-- Filter Regional -->
                    <div class="relative w-full sm:w-auto">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-solid fa-map-location text-gray-400"></i>
                        </div>
                        <select id="dashboard-filter-region" onchange="handleRegionFilterChange()" class="w-full sm:w-48 pl-10 pr-8 py-2 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-white text-gray-700">
                            <option value="all">Semua Regional</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <!-- Filter Event -->
                    <div class="relative w-full sm:w-auto">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-solid fa-calendar-day text-gray-400"></i>
                        </div>
                        <select id="dashboard-filter-event" onchange="applyFilter()" class="w-full sm:w-48 pl-10 pr-8 py-2 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-white text-gray-700 disabled:bg-gray-100 disabled:text-gray-400" disabled>
                            <option value="all">Semua Acara</option>
                            <!-- Populated by JS based on region -->
                        </select>
                    </div>

                    <button onclick="fetchData()" class="w-full sm:w-auto bg-white p-2 px-4 rounded shadow hover:bg-gray-50 text-primary border border-gray-200 font-medium transition">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-gray-500 text-sm font-semibold uppercase">Total Pemasukan</div>
                            <div class="text-2xl font-bold text-green-600 mt-2" id="total-income">Rp 0</div>
                        </div>
                        <i class="fa-solid fa-circle-dollar-to-slot text-green-100 text-5xl absolute -right-2 -bottom-4"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500 relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-gray-500 text-sm font-semibold uppercase">Total Pengeluaran</div>
                            <div class="text-2xl font-bold text-red-600 mt-2" id="total-expense">Rp 0</div>
                        </div>
                        <i class="fa-solid fa-money-bill-transfer text-red-100 text-5xl absolute -right-2 -bottom-4"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-gray-500 text-sm font-semibold uppercase">Saldo Akhir</div>
                            <div class="text-2xl font-bold text-blue-800 mt-2" id="net-balance">Rp 0</div>
                        </div>
                        <i class="fa-solid fa-wallet text-blue-100 text-5xl absolute -right-2 -bottom-4"></i>
                    </div>
                </div>
            </div>

            <!-- CHARTS SECTION -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <!-- Chart 1: Cash Flow -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Arus Kas Bulanan</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Breakdown -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2" id="breakdown-title">Distribusi Keuangan</h3>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="breakdownChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mt-8">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center flex-wrap gap-2">
                    <h3 class="font-bold text-gray-700" id="table-title">Riwayat Transaksi</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-600 uppercase font-semibold">
                            <tr>
                                <th class="px-6 py-3">Tanggal</th>
                                <th class="px-6 py-3">Regional & Acara</th>
                                <th class="px-6 py-3">Keterangan</th>
                                <th class="px-6 py-3 text-right">Jumlah</th>
                                <th class="px-6 py-3 text-center">Tipe</th>
                                <th class="px-6 py-3 text-center">Bukti</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="divide-y divide-gray-200">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- INPUT SECTION -->
        <section id="input" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Catat Transaksi Baru</h2>
            <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                <form id="transaction-form" onsubmit="handleTransactionSubmit(event)">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <!-- Regional -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Regional</label>
                            <select id="t-region" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-primary" onchange="updateEventSuggestions()" required>
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <!-- Nama Acara -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nama Acara / Kegiatan</label>
                            <input type="text" id="t-event" list="event-suggestions" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-primary" placeholder="Cth: Bandung Menyapa 1" required>
                            <datalist id="event-suggestions">
                                <!-- Populated by JS based on existing data -->
                            </datalist>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                         <!-- Tipe -->
                         <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Jenis Transaksi</label>
                            <select id="t-type" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-primary" required>
                                <option value="income">Pemasukan (Donasi/Dana)</option>
                                <option value="expense">Pengeluaran (Operasional)</option>
                            </select>
                        </div>
                        
                        <!-- Jumlah -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Jumlah (Rp)</label>
                            <input type="number" id="t-amount" min="1" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-primary" placeholder="Contoh: 1000000" required>
                        </div>
                    </div>

                    <!-- Deskripsi -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan Transaksi</label>
                        <textarea id="t-desc" rows="2" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-primary" placeholder="Contoh: Pembelian 100 nasi box untuk relawan" required></textarea>
                    </div>

                    <!-- Bukti Upload -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Upload Bukti (Disimpan di Supabase)</label>
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col w-full h-32 border-2 border-dashed border-gray-300 hover:bg-gray-50 hover:border-primary rounded cursor-pointer transition">
                                <div class="flex flex-col items-center justify-center pt-7">
                                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400"></i>
                                    <p class="pt-1 text-sm tracking-wider text-gray-400 group-hover:text-gray-600">Pilih file gambar</p>
                                </div>
                                <input type="file" id="t-proof" class="opacity-0" accept="image/*" />
                            </label>
                        </div>
                        <p id="file-name" class="text-xs text-gray-500 mt-2 text-center"></p>
                    </div>

                    <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded hover:bg-blue-700 transition duration-300 shadow-lg">
                        <i class="fa-solid fa-save mr-2"></i> Simpan Transaksi
                    </button>
                </form>
            </div>
        </section>

        <!-- REGIONS SECTION -->
        <section id="regions" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Kelola Regional</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                    <h3 class="text-xl font-bold mb-4">Tambah Regional Baru</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-region-name" class="flex-1 p-2 border border-gray-300 rounded focus:border-primary focus:outline-none" placeholder="Nama Kota/Provinsi">
                        <button onclick="addRegion()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow">
                            <i class="fa-solid fa-plus"></i> Tambah
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Daftar Regional Aktif</h3>
                    <ul id="regions-list" class="divide-y divide-gray-200">
                        <!-- JS injected -->
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Image Modal -->
    <div id="image-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4" onclick="closeModal()">
        <img id="modal-img" src="" class="max-h-screen max-w-full rounded shadow-lg">
        <button class="absolute top-5 right-5 text-white text-3xl hover:text-gray-300">&times;</button>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://ljhcszzmuaourbwwozmf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE MANAGEMENT ---
        let regions = JSON.parse(localStorage.getItem('ngo_regions')) || ['Jakarta', 'Bandung', 'Surabaya', 'Papua'];
        let transactions = [];
        let currentRegionFilter = 'all'; 
        let currentEventFilter = 'all';

        // --- CHARTS VARIABLES ---
        let cashFlowChartInstance = null;
        let breakdownChartInstance = null;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderRegions();
            fetchData();
            
            document.getElementById('t-proof').addEventListener('change', function(e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : '';
                document.getElementById('file-name').textContent = fileName;
            });
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-gray-800', 'border-primary');
                el.classList.add('border-transparent');
            });
            document.getElementById('nav-' + sectionId).classList.add('bg-gray-800', 'border-primary');
            document.getElementById('nav-' + sectionId).classList.remove('border-transparent');
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            showLoading(true);
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                transactions = data || [];
                handleRegionFilterChange(false);
            } catch (err) {
                console.error('Error fetching data:', err);
                if(err.code === "42P01") { 
                    alert("Tabel 'transactions' belum ditemukan.");
                } else if (err.message.includes('event_name')) {
                    alert("Kolom 'event_name' belum ditemukan. Harap update database.");
                } else {
                    alert("Gagal mengambil data: " + err.message);
                }
            } finally {
                showLoading(false);
            }
        }

        // --- FILTERING LOGIC ---
        function handleRegionFilterChange(resetEvent = true) {
            const regionSelect = document.getElementById('dashboard-filter-region');
            const eventSelect = document.getElementById('dashboard-filter-event');
            
            currentRegionFilter = regionSelect.value;
            
            if (resetEvent) {
                currentEventFilter = 'all';
                eventSelect.value = 'all';
            } else {
                currentEventFilter = eventSelect.value;
            }

            if (currentRegionFilter === 'all') {
                eventSelect.disabled = true;
                eventSelect.innerHTML = '<option value="all">Semua Acara</option>';
            } else {
                eventSelect.disabled = false;
                populateEventFilter(currentRegionFilter, eventSelect);
            }

            applyFilter();
        }

        function populateEventFilter(region, selectElement) {
            const eventsInRegion = [...new Set(
                transactions
                .filter(t => t.region === region && t.event_name)
                .map(t => t.event_name)
            )];

            const currentVal = selectElement.value;
            selectElement.innerHTML = '<option value="all">Semua Acara</option>';
            eventsInRegion.forEach(evt => {
                const opt = document.createElement('option');
                opt.value = evt;
                opt.innerText = evt;
                selectElement.appendChild(opt);
            });

            if (eventsInRegion.includes(currentVal)) selectElement.value = currentVal;
            else if (currentVal === 'all') selectElement.value = 'all';
        }

        function applyFilter() {
            currentRegionFilter = document.getElementById('dashboard-filter-region').value;
            currentEventFilter = document.getElementById('dashboard-filter-event').value;

            const titleEl = document.getElementById('table-title');
            let filtered = transactions;

            if (currentRegionFilter !== 'all') {
                filtered = filtered.filter(t => t.region === currentRegionFilter);
            }

            if (currentRegionFilter !== 'all' && currentEventFilter !== 'all') {
                filtered = filtered.filter(t => t.event_name === currentEventFilter);
                titleEl.textContent = `Riwayat: ${currentRegionFilter} - ${currentEventFilter}`;
            } else if (currentRegionFilter !== 'all') {
                titleEl.textContent = `Riwayat: ${currentRegionFilter} (Semua Acara)`;
            } else {
                titleEl.textContent = 'Riwayat Transaksi (Semua)';
            }

            updateDashboard(filtered);
            renderTransactionList(filtered);
            updateCharts(filtered);
        }

        function updateDashboard(dataToDisplay) {
            let income = 0;
            let expense = 0;

            dataToDisplay.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.type === 'income') income += amount;
                else if (t.type === 'expense') expense += amount;
            });

            document.getElementById('total-income').innerText = formatRupiah(income);
            document.getElementById('total-expense').innerText = formatRupiah(expense);
            document.getElementById('net-balance').innerText = formatRupiah(income - expense);
        }

        // --- CHART LOGIC (NEW) ---
        function updateCharts(data) {
            // 1. Prepare Cash Flow Data (Monthly)
            const monthlyData = {};
            data.forEach(t => {
                const date = new Date(t.created_at);
                const key = date.toLocaleString('id-ID', { month: 'short', year: 'numeric' }); // Jan 2024
                
                if (!monthlyData[key]) monthlyData[key] = { income: 0, expense: 0, sortDate: date.getTime() };
                
                if (t.type === 'income') monthlyData[key].income += parseFloat(t.amount);
                else monthlyData[key].expense += parseFloat(t.amount);
            });

            // Sort by Date
            const sortedKeys = Object.keys(monthlyData).sort((a, b) => monthlyData[a].sortDate - monthlyData[b].sortDate);
            const labels = sortedKeys;
            const incomeData = sortedKeys.map(k => monthlyData[k].income);
            const expenseData = sortedKeys.map(k => monthlyData[k].expense);

            // Render Cash Flow Chart
            const ctx1 = document.getElementById('cashFlowChart').getContext('2d');
            if (cashFlowChartInstance) cashFlowChartInstance.destroy();

            cashFlowChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Pemasukan', data: incomeData, backgroundColor: '#22c55e', borderRadius: 4 },
                        { label: 'Pengeluaran', data: expenseData, backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 2. Prepare Breakdown Data
            // Logic: 
            // - If 'All Regions' selected -> Show Income by Region (to see where money comes from)
            // - If Specific Region selected -> Show Expenses by Event (to see where money goes)
            
            const breakdownData = {};
            const breakdownTitle = document.getElementById('breakdown-title');
            let labelType = '';

            if (currentRegionFilter === 'all') {
                breakdownTitle.textContent = "Sumber Pemasukan per Regional";
                labelType = 'region';
                // Filter only Income for this view
                const incomeOnly = data.filter(t => t.type === 'income');
                incomeOnly.forEach(t => {
                    const key = t.region || 'Unknown';
                    breakdownData[key] = (breakdownData[key] || 0) + parseFloat(t.amount);
                });
            } else {
                breakdownTitle.textContent = `Pengeluaran per Acara (${currentRegionFilter})`;
                labelType = 'event';
                // Filter only Expense for this view
                const expenseOnly = data.filter(t => t.type === 'expense');
                expenseOnly.forEach(t => {
                    const key = t.event_name || 'Lain-lain';
                    breakdownData[key] = (breakdownData[key] || 0) + parseFloat(t.amount);
                });
            }

            const pieLabels = Object.keys(breakdownData);
            const pieValues = Object.values(breakdownData);
            const pieColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];

            // Render Breakdown Chart
            const ctx2 = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChartInstance) breakdownChartInstance.destroy();

            breakdownChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: pieLabels.length ? pieLabels : ['Tidak ada data'],
                    datasets: [{
                        data: pieValues.length ? pieValues : [1],
                        backgroundColor: pieValues.length ? pieColors : ['#e5e7eb'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // --- LIST RENDER ---
        function renderTransactionList(dataToDisplay) {
            const tbody = document.getElementById('transaction-list');
            tbody.innerHTML = '';

            if (dataToDisplay.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">Tidak ada transaksi ditemukan.</td></tr>`;
                return;
            }

            dataToDisplay.forEach(t => {
                const date = new Date(t.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                const typeBadge = t.type === 'income' 
                    ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">Masuk</span>`
                    : `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold">Keluar</span>`;
                
                const amountClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                
                const proofBtn = t.proof_url 
                    ? `<button onclick="viewProof('${t.proof_url}')" class="text-blue-600 hover:text-blue-800 underline text-xs"><i class="fa-solid fa-image"></i> Lihat</button>`
                    : `<span class="text-gray-300 text-xs italic">-</span>`;
                
                const eventDisplay = t.event_name 
                    ? `<div class="font-bold text-gray-800">${t.event_name}</div><div class="text-xs text-gray-500"><i class="fa-solid fa-map-pin"></i> ${t.region}</div>`
                    : `<div class="text-gray-600">${t.region}</div>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 text-sm align-top">${date}</td>
                        <td class="px-6 py-4 align-top">${eventDisplay}</td>
                        <td class="px-6 py-4 text-gray-600 text-sm align-top">${t.description}</td>
                        <td class="px-6 py-4 text-right font-bold ${amountClass} text-sm align-top">${formatRupiah(t.amount)}</td>
                         <td class="px-6 py-4 align-top text-center">${typeBadge}</td>
                        <td class="px-6 py-4 text-center align-top">${proofBtn}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- ADD TRANSACTION ---
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            showLoading(true);

            const type = document.getElementById('t-type').value;
            const region = document.getElementById('t-region').value;
            const eventName = document.getElementById('t-event').value;
            const amount = document.getElementById('t-amount').value;
            const description = document.getElementById('t-desc').value;
            const fileInput = document.getElementById('t-proof');
            const file = fileInput.files[0];

            let proofUrl = null;

            try {
                if (file) {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const { data: uploadData, error: uploadError } = await supabase
                        .storage.from('proofs').upload(fileName, file);

                    if (uploadError) {
                        alert("Gagal upload gambar. Transaksi disimpan tanpa gambar.");
                    } else {
                        const { data: publicUrlData } = supabase.storage.from('proofs').getPublicUrl(fileName);
                        proofUrl = publicUrlData.publicUrl;
                    }
                }

                const { error: insertError } = await supabase
                    .from('transactions')
                    .insert([{ 
                        type, region, event_name: eventName, 
                        amount: parseFloat(amount), description, proof_url: proofUrl 
                    }]);

                if (insertError) throw insertError;

                alert('Transaksi berhasil disimpan!');
                document.getElementById('transaction-form').reset();
                document.getElementById('file-name').textContent = '';
                showSection('dashboard');
                fetchData(); 

            } catch (err) {
                console.error(err);
                alert('Terjadi kesalahan: ' + err.message);
            } finally {
                showLoading(false);
            }
        }

        function updateEventSuggestions() {
            const region = document.getElementById('t-region').value;
            const dataList = document.getElementById('event-suggestions');
            dataList.innerHTML = '';
            
            const uniqueEvents = [...new Set(
                transactions
                .filter(t => t.region === region && t.event_name)
                .map(t => t.event_name)
            )];

            uniqueEvents.forEach(evt => {
                const opt = document.createElement('option');
                opt.value = evt;
                dataList.appendChild(opt);
            });
        }

        function renderRegions() {
            const list = document.getElementById('regions-list');
            list.innerHTML = '';
            regions.forEach((r, index) => {
                list.innerHTML += `
                    <li class="py-3 flex justify-between items-center">
                        <span class="font-medium text-gray-700">${r}</span>
                        <button onclick="deleteRegion(${index})" class="text-red-500 hover:text-red-700 text-sm bg-red-50 hover:bg-red-100 p-2 rounded transition">
                            <i class="fa-solid fa-trash"></i> Hapus
                        </button>
                    </li>
                `;
            });
            localStorage.setItem('ngo_regions', JSON.stringify(regions));
            updateRegionDropdowns();
        }

        function addRegion() {
            const input = document.getElementById('new-region-name');
            const val = input.value.trim();
            if (val && !regions.includes(val)) {
                regions.push(val);
                input.value = '';
                renderRegions();
                alert(`Regional ${val} berhasil ditambahkan.`);
            } else if (regions.includes(val)) {
                alert('Regional sudah ada.');
            }
        }

        function deleteRegion(index) {
            if(confirm(`Hapus regional ${regions[index]}?`)) {
                regions.splice(index, 1);
                renderRegions();
            }
        }

        function updateRegionDropdowns() {
            const inputSelect = document.getElementById('t-region');
            const currentInputVal = inputSelect.value;
            inputSelect.innerHTML = '';
            regions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.innerText = r;
                inputSelect.appendChild(opt);
            });
            if(regions.includes(currentInputVal)) inputSelect.value = currentInputVal;

            const filterSelect = document.getElementById('dashboard-filter-region');
            const currentFilterVal = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">Semua Regional</option>';
            regions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.innerText = r;
                filterSelect.appendChild(opt);
            });
            if (currentFilterVal === 'all' || regions.includes(currentFilterVal)) filterSelect.value = currentFilterVal;
            else filterSelect.value = 'all';
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function viewProof(url) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-img');
            img.src = url;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
