<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan NGO - Master Event</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (Untuk Export Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af', // Blue 800
                        secondary: '#0f172a', // Slate 900
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col md:flex-row">

    <!-- Sidebar Navigation -->
    <aside class="w-full md:w-64 bg-secondary text-white flex-shrink-0 fixed md:static bottom-0 z-40 md:h-screen shadow-xl">
        <div class="p-6 hidden md:block">
            <h1 class="text-2xl font-bold"><i class="fa-solid fa-hand-holding-heart mr-2"></i>NGO Finance</h1>
            <p class="text-xs text-gray-400 mt-1">v5.3 Pro Quick Region</p>
        </div>
        <nav class="md:mt-4 flex md:flex-col overflow-x-auto md:overflow-visible w-full bg-secondary">
            <a href="#" onclick="showSection('dashboard')" class="flex-1 md:flex-none block py-3 px-6 hover:bg-gray-700 transition nav-item active-nav border-t-4 md:border-t-0 md:border-l-4 border-primary bg-gray-800 text-center md:text-left text-xs md:text-base" id="nav-dashboard">
                <i class="fa-solid fa-chart-line md:w-6 block md:inline mb-1 md:mb-0"></i> Dashboard
            </a>
            <a href="#" onclick="showSection('input')" class="flex-1 md:flex-none block py-3 px-6 hover:bg-gray-700 transition nav-item border-t-4 md:border-t-0 md:border-l-4 border-transparent text-center md:text-left text-xs md:text-base" id="nav-input">
                <i class="fa-solid fa-plus-circle md:w-6 block md:inline mb-1 md:mb-0"></i> Transaksi
            </a>
            <a href="#" onclick="showSection('events')" class="flex-1 md:flex-none block py-3 px-6 hover:bg-gray-700 transition nav-item border-t-4 md:border-t-0 md:border-l-4 border-transparent text-center md:text-left text-xs md:text-base" id="nav-events">
                <i class="fa-solid fa-calendar-check md:w-6 block md:inline mb-1 md:mb-0"></i> Data Acara
            </a>
            <a href="#" onclick="showSection('regions')" class="flex-1 md:flex-none block py-3 px-6 hover:bg-gray-700 transition nav-item border-t-4 md:border-t-0 md:border-l-4 border-transparent text-center md:text-left text-xs md:text-base" id="nav-regions">
                <i class="fa-solid fa-map-location-dot md:w-6 block md:inline mb-1 md:mb-0"></i> Regional
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto mb-16 md:mb-0">
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
            <div class="bg-white p-5 rounded-lg shadow-lg flex items-center">
                <i class="fa-solid fa-spinner fa-spin text-primary text-2xl mr-3"></i>
                <span>Memproses data...</span>
            </div>
        </div>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="content-section space-y-6">
            <!-- Header & Filter -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-lg shadow-sm">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-sm text-gray-500">Monitor keuangan per regional & acara</p>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto">
                    <!-- Filter Regional -->
                    <select id="dashboard-filter-region" onchange="handleRegionFilterChange()" class="filter-select w-full sm:w-auto">
                        <option value="all">Semua Regional</option>
                    </select>
                    <!-- Filter Acara -->
                    <select id="dashboard-filter-event" onchange="applyFilter()" class="filter-select disabled:bg-gray-100 w-full sm:w-auto" disabled>
                        <option value="all">Semua Acara</option>
                    </select>
                    <!-- Action Buttons -->
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="fetchData()" class="btn-icon" title="Refresh Data"><i class="fa-solid fa-arrows-rotate"></i></button>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2 text-sm font-bold w-full justify-center sm:w-auto">
                            <i class="fa-solid fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stats-card border-green-500">
                    <div class="title">Total Pemasukan</div>
                    <div class="value text-green-600" id="total-income">Rp 0</div>
                </div>
                <div class="stats-card border-red-500">
                    <div class="title">Total Pengeluaran</div>
                    <div class="value text-red-600" id="total-expense">Rp 0</div>
                </div>
                <div class="stats-card border-blue-500">
                    <div class="title">Saldo Akhir</div>
                    <div class="value text-blue-800" id="net-balance">Rp 0</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
                <div class="chart-container">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Arus Kas Bulanan</h3>
                    <div class="relative h-[280px]">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2" id="breakdown-title">Distribusi</h3>
                    <div class="relative h-[280px] flex justify-center">
                        <canvas id="breakdownChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden mt-6">
                <div class="px-6 py-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between items-center">
                    <span>Riwayat Transaksi Terakhir</span>
                    <span class="text-xs font-normal text-gray-500">*Data real-time</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-600 uppercase font-semibold">
                            <tr>
                                <th class="px-4 py-3">Tanggal</th>
                                <th class="px-4 py-3">Regional / Acara</th>
                                <th class="px-4 py-3">Kategori</th>
                                <th class="px-4 py-3">Ket.</th>
                                <th class="px-4 py-3 text-right">Jumlah</th>
                                <th class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- INPUT SECTION -->
        <section id="input" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Input Transaksi Baru</h2>
            <div class="bg-white p-6 rounded-lg shadow max-w-4xl mx-auto border-t-4 border-primary">
                <form id="transaction-form" onsubmit="handleTransactionSubmit(event)">
                    <input type="hidden" id="t-id">
                    
                    <!-- MASTER DATA SELECTION -->
                    <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 mb-6 relative">
                        <div class="absolute top-4 right-4 flex items-center bg-white px-3 py-1 rounded-full shadow-sm border border-blue-100">
                            <input type="checkbox" id="keep-context" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                            <label for="keep-context" class="ml-2 text-xs font-bold text-blue-700 cursor-pointer select-none">
                                Kunci Pilihan (Input Beruntun)
                            </label>
                        </div>
                        
                        <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-4"><i class="fa-solid fa-layer-group mr-2"></i>1. Pilih Konteks</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Regional -->
                            <div>
                                <label class="label-text">Regional / Wilayah</label>
                                <div class="flex gap-2">
                                    <select id="t-region" class="input-field bg-white" onchange="loadEventsForRegion(this.value)" required>
                                        <!-- JS Populated -->
                                    </select>
                                    <button type="button" onclick="quickAddRegion()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Tambah Regional Baru">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1">
                                    *Klik (+) untuk menambah regional baru secara instan.
                                </p>
                            </div>
                            
                            <!-- Event Selector -->
                            <div>
                                <label class="label-text flex justify-between">
                                    <span>Pilih Acara / Program</span>
                                    <span class="text-xs font-normal text-gray-500 italic">Wajib pilih dari daftar</span>
                                </label>
                                <div class="flex gap-2">
                                    <select id="t-event-select" class="input-field bg-white font-medium text-gray-700" required>
                                        <option value="">-- Pilih Regional Dahulu --</option>
                                    </select>
                                    <button type="button" onclick="quickAddEvent()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow" title="Buat Acara Baru">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1">
                                    *Jika acara belum ada, klik tombol <b>(+)</b> untuk menambahkan ke database.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSACTION DETAILS -->
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3 px-1"><i class="fa-solid fa-file-invoice-dollar mr-2"></i>2. Detail Keuangan</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="label-text">Jenis Transaksi</label>
                            <select id="t-type" class="input-field font-bold" required>
                                <option value="expense" class="text-red-600">Pengeluaran (Keluar)</option>
                                <option value="income" class="text-green-600">Pemasukan (Masuk)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="label-text">Kategori</label>
                            <input type="text" id="t-category" list="category-suggestions" class="input-field" placeholder="Cth: Konsumsi, Transport, Donasi" required>
                            <datalist id="category-suggestions">
                                <option value="Operasional"><option value="Konsumsi"><option value="Transportasi">
                                <option value="Donasi Umum"><option value="Sponsorship"><option value="Belanja Modal">
                            </datalist>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="label-text">Jumlah (Rp)</label>
                            <input type="number" id="t-amount" min="1" class="input-field text-lg font-bold text-gray-800" placeholder="0" required>
                        </div>
                        <div>
                            <label class="label-text">Tanggal</label>
                            <input type="date" id="t-date" class="input-field" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="label-text">Keterangan Tambahan</label>
                        <textarea id="t-desc" rows="2" class="input-field" placeholder="Detail keperluan..."></textarea>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Upload Bukti</label>
                        <input type="file" id="t-proof" class="input-field p-2 bg-gray-50" accept="image/*">
                        <div id="current-proof" class="mt-2 text-xs hidden">
                            <a href="#" target="_blank" id="current-proof-link" class="text-blue-600 hover:underline"><i class="fa-solid fa-paperclip"></i> Lihat bukti saat ini</a>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded hover:bg-blue-800 shadow-lg transition transform active:scale-95">
                            <i class="fa-solid fa-save mr-2"></i> Simpan Transaksi
                        </button>
                        <button type="button" onclick="resetForm(true)" class="px-5 py-3 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-medium">
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- EVENT MASTER DATA SECTION (NEW) -->
        <section id="events" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Database Acara</h2>
            
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Daftar Semua Program/Acara</h3>
                    <button onclick="fetchEvents()" class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200"><i class="fa-solid fa-sync"></i> Refresh</button>
                </div>
                
                <p class="text-sm text-gray-500 mb-4 bg-yellow-50 p-3 rounded border border-yellow-100">
                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i>
                    Acara yang didaftarkan di sini akan muncul otomatis di menu dropdown saat input transaksi.
                </p>

                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10">
                            <tr>
                                <th class="p-3">Regional</th>
                                <th class="p-3">Nama Acara</th>
                                <th class="p-3 text-center">Status</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="master-event-list" class="divide-y divide-gray-100">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REGIONS SECTION -->
        <section id="regions" class="content-section hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kelola Regional</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow h-fit">
                    <h3 class="font-bold mb-3">Tambah Regional</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-region-name" class="input-field" placeholder="Nama Kota/Area">
                        <button onclick="addRegion()" class="bg-green-600 text-white px-4 rounded hover:bg-green-700">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold mb-3">Daftar Regional</h3>
                    <ul id="regions-list" class="divide-y divide-gray-100"></ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal Image -->
    <div id="image-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4" onclick="closeModal()">
        <img id="modal-img" src="" class="max-h-screen max-w-full rounded shadow-lg">
        <button class="absolute top-5 right-5 text-white text-3xl">&times;</button>
    </div>

    <style>
        .input-field { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #1e40af; ring: 2px; box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }
        .label-text { display: block; font-size: 0.8rem; font-weight: 700; color: #4b5563; margin-bottom: 0.3rem; }
        .filter-select { padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; outline: none; font-size: 0.9rem; }
        .btn-icon { padding: 0.5rem 1rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 0.375rem; color: #1e40af; }
        .btn-icon:hover { background: #f3f4f6; }
        .stats-card { background: white; padding: 1.25rem; border-radius: 0.5rem; border-left-width: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-card .title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; }
        .stats-card .value { font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem; }
        .chart-container { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 320px; position: relative; }
    </style>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://ljhcszzmuaourbwwozmf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let regions = JSON.parse(localStorage.getItem('ngo_regions')) || ['Jakarta', 'Bandung', 'Surabaya', 'Papua'];
        let transactions = [];
        let eventsList = []; // Master Data Events
        let currentRegionFilter = 'all';
        let currentEventFilter = 'all';
        let cashFlowChartInstance = null;
        let breakdownChartInstance = null;
        let isEditing = false;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('t-date').valueAsDate = new Date();
            renderRegions();
            fetchData();
            fetchEvents();
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Re-render nav state
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-gray-800', 'border-primary');
                el.classList.add('border-transparent');
            });
            document.getElementById('nav-' + sectionId).classList.add('bg-gray-800', 'border-primary');
            document.getElementById('nav-' + sectionId).classList.remove('border-transparent');

            // Force refresh UI components if entering dashboard to ensure updated lists
            if (sectionId === 'dashboard') {
                renderRegions(); // Update dropdowns just in case
                fetchEvents();
            } else if (sectionId === 'events') {
                fetchEvents();
            }
        }

        // --- DATA OPERATIONS ---
        async function fetchData() {
            showLoading(true);
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                transactions = data || [];
                handleRegionFilterChange(false);
            } catch (err) {
                console.error(err);
                Swal.fire('Error', err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function fetchEvents() {
            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) {
                    if(error.code === '42P01') return; // Ignore if table missing initially
                    return;
                }
                eventsList = data || [];
                renderMasterEventList();
                // If we are on input page, refresh dropdown
                const currentRegion = document.getElementById('t-region').value;
                if(currentRegion) loadEventsForRegion(currentRegion);
            } catch (err) { console.error(err); }
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            showLoading(true);

            const id = document.getElementById('t-id').value;
            const type = document.getElementById('t-type').value;
            const region = document.getElementById('t-region').value;
            const eventName = document.getElementById('t-event-select').value; 
            const category = document.getElementById('t-category').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const date = document.getElementById('t-date').value;
            const description = document.getElementById('t-desc').value;
            const file = document.getElementById('t-proof').files[0];

            if (!eventName) {
                showLoading(false);
                Swal.fire('Error', 'Silakan pilih Acara. Jika belum ada, buat acara baru dengan tombol (+).', 'warning');
                return;
            }

            const payload = {
                type, region, event_name: eventName, category, amount, description,
                created_at: new Date(date).toISOString() 
            };

            try {
                if (file) {
                    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2,5)}.${file.name.split('.').pop()}`;
                    const { error: uploadError } = await supabase.storage.from('proofs').upload(fileName, file);
                    if (!uploadError) {
                        const { data } = supabase.storage.from('proofs').getPublicUrl(fileName);
                        payload.proof_url = data.publicUrl;
                    }
                }

                if (isEditing && id) {
                    const { error } = await supabase.from('transactions').update(payload).eq('id', id);
                    if (error) throw error;
                    Swal.fire('Sukses', 'Transaksi diperbarui!', 'success');
                } else {
                    const { error } = await supabase.from('transactions').insert([payload]);
                    if (error) throw error;
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                        didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
                    });
                    Toast.fire({ icon: 'success', title: 'Data tersimpan' });
                }

                resetForm();
                if(!document.getElementById('dashboard').classList.contains('hidden')) fetchData();
                else {
                    const { data } = await supabase.from('transactions').select('*').order('created_at', {ascending: false});
                    if(data) transactions = data; 
                }
            } catch (err) {
                Swal.fire('Gagal', err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteTransaction(id) {
            const result = await Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Hapus' });
            if (result.isConfirmed) {
                showLoading(true);
                await supabase.from('transactions').delete().eq('id', id);
                showLoading(false);
                fetchData();
                Swal.fire('Terhapus', '', 'success');
            }
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id == id);
            if (!t) return;
            isEditing = true;
            showSection('input');
            
            document.getElementById('t-id').value = t.id;
            document.getElementById('t-region').value = t.region;
            loadEventsForRegion(t.region, t.event_name);

            document.getElementById('t-category').value = t.category || '';
            document.getElementById('t-type').value = t.type;
            document.getElementById('t-amount').value = t.amount;
            document.getElementById('t-desc').value = t.description || '';
            document.getElementById('t-date').value = new Date(t.created_at).toISOString().split('T')[0];

            document.getElementById('keep-context').checked = false;
            document.getElementById('keep-context').disabled = true;

            const proofLink = document.getElementById('current-proof');
            if (t.proof_url) {
                document.getElementById('current-proof-link').href = t.proof_url;
                proofLink.classList.remove('hidden');
            } else { proofLink.classList.add('hidden'); }
        }

        function resetForm(forceFullReset = false) {
            const keepContext = document.getElementById('keep-context').checked;
            const region = document.getElementById('t-region').value;
            const eventName = document.getElementById('t-event-select').value;
            const date = document.getElementById('t-date').value;
            const category = document.getElementById('t-category').value;
            
            document.getElementById('transaction-form').reset();
            
            if(keepContext && !forceFullReset && !isEditing) {
                document.getElementById('t-region').value = region;
                loadEventsForRegion(region, eventName); 
                document.getElementById('t-date').value = date;
                document.getElementById('t-category').value = category;
                document.getElementById('keep-context').checked = true;
            } else {
                document.getElementById('t-date').valueAsDate = new Date();
                document.getElementById('keep-context').checked = false;
                document.getElementById('keep-context').disabled = false;
                if(!region) document.getElementById('t-event-select').innerHTML = '<option value="">-- Pilih Regional Dahulu --</option>';
            }
            isEditing = false;
            document.getElementById('t-id').value = '';
            document.getElementById('current-proof').classList.add('hidden');
        }

        function loadEventsForRegion(regionName, selectedEvent = null) {
            const select = document.getElementById('t-event-select');
            select.innerHTML = ''; // Clear properly
            
            if (!regionName) {
                select.add(new Option('-- Pilih Regional Dahulu --', ''));
                return;
            }
            select.add(new Option('-- Pilih Acara --', ''));

            const regionEvents = eventsList.filter(e => e.region === regionName && e.status !== 'completed');
            
            if (regionEvents.length === 0) {
                 const opt = new Option('Belum ada acara. Klik (+) untuk buat baru.', '');
                 opt.disabled = true;
                 select.add(opt);
            }

            regionEvents.forEach(evt => {
                select.add(new Option(evt.name, evt.name));
            });

            select.add(new Option('Operasional Rutin (Tanpa Event)', 'Operasional Rutin'));

            if (selectedEvent) {
                // Handle legacy/custom events not in master
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === selectedEvent) exists = true;
                }
                
                if (!exists) {
                    select.add(new Option(selectedEvent + " (Legacy)", selectedEvent));
                }
                select.value = selectedEvent;
            }
        }

        async function quickAddEvent() {
            const region = document.getElementById('t-region').value;
            if (!region) { Swal.fire('Info', 'Pilih Regional terlebih dahulu.', 'info'); return; }

            const { value: newEventName } = await Swal.fire({
                title: 'Buat Acara Baru',
                text: `Menambahkan acara baru di ${region}:`,
                input: 'text',
                inputPlaceholder: 'Cth: Bandung Menyapa 2',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                inputValidator: (value) => { if (!value) return 'Nama acara tidak boleh kosong!'; }
            });

            if (newEventName) {
                showLoading(true);
                const { error } = await supabase.from('events').insert([{ region: region, name: newEventName, status: 'active' }]);
                if (error) { showLoading(false); Swal.fire('Error', error.message, 'error'); } 
                else {
                    await fetchEvents();
                    showLoading(false);
                    loadEventsForRegion(region, newEventName);
                    Swal.fire('Berhasil', `Acara "${newEventName}" siap digunakan!`, 'success');
                }
            }
        }
        
        async function quickAddRegion() {
            const { value: newRegion } = await Swal.fire({
                title: 'Tambah Regional Baru',
                input: 'text',
                inputLabel: 'Nama Kota / Wilayah',
                inputPlaceholder: 'Contoh: Medan',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                inputValidator: (value) => {
                    if (!value) return 'Nama tidak boleh kosong!';
                    if (regions.includes(value)) return 'Regional sudah ada!';
                }
            });

            if (newRegion) {
                regions.push(newRegion);
                renderRegions(); // Updates LS and Dropdowns
                
                // Select the new region immediately
                document.getElementById('t-region').value = newRegion;
                
                // Trigger event loading (though likely empty for new region)
                loadEventsForRegion(newRegion);
                
                Swal.fire('Berhasil', `Regional "${newRegion}" ditambahkan!`, 'success');
            }
        }

        function renderMasterEventList() {
            const tbody = document.getElementById('master-event-list');
            tbody.innerHTML = '';
            if (eventsList.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada data acara.</td></tr>'; return; }

            eventsList.forEach(evt => {
                const isActive = evt.status !== 'completed';
                const statusBadge = isActive ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Aktif</span>` : `<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs">Selesai</span>`;
                const btn = isActive ? `<button onclick="toggleEventStatus(${evt.id}, 'completed')" class="text-xs border border-gray-300 px-2 py-1 rounded hover:bg-gray-100">Arsipkan</button>` : `<button onclick="toggleEventStatus(${evt.id}, 'active')" class="text-xs border border-blue-300 text-blue-600 px-2 py-1 rounded hover:bg-blue-50">Aktifkan</button>`;
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="p-3">${evt.region}</td><td class="p-3 font-bold text-blue-900">${evt.name}</td><td class="p-3 text-center">${statusBadge}</td><td class="p-3 text-center">${btn}</td></tr>`;
            });
        }

        async function toggleEventStatus(id, newStatus) {
            showLoading(true);
            await supabase.from('events').update({ status: newStatus }).eq('id', id);
            await fetchEvents();
            showLoading(false);
        }

        // --- FILTERING & CHARTS ---
        function handleRegionFilterChange(resetEvent = true) {
            const regionSelect = document.getElementById('dashboard-filter-region');
            const eventSelect = document.getElementById('dashboard-filter-event');
            currentRegionFilter = regionSelect.value;
            
            if (resetEvent) { currentEventFilter = 'all'; eventSelect.value = 'all'; }
            
            if (currentRegionFilter === 'all') {
                eventSelect.disabled = true;
                eventSelect.innerHTML = '<option value="all">Semua Acara</option>';
            } else {
                eventSelect.disabled = false;
                const events = [...new Set([
                    ...eventsList.filter(e => e.region === currentRegionFilter).map(e => e.name),
                    ...transactions.filter(t => t.region === currentRegionFilter && t.event_name).map(t => t.event_name)
                ])];
                eventSelect.innerHTML = '<option value="all">Semua Acara</option>';
                events.forEach(e => eventSelect.add(new Option(e, e)));
                eventSelect.value = currentEventFilter;
            }
            applyFilter();
        }

        function applyFilter() {
            currentRegionFilter = document.getElementById('dashboard-filter-region').value;
            currentEventFilter = document.getElementById('dashboard-filter-event').value;
            
            let filtered = transactions;
            if (currentRegionFilter !== 'all') filtered = filtered.filter(t => t.region === currentRegionFilter);
            if (currentRegionFilter !== 'all' && currentEventFilter !== 'all') filtered = filtered.filter(t => t.event_name === currentEventFilter);

            updateDashboard(filtered);
            renderTransactionList(filtered);
            updateCharts(filtered);
        }

        function updateDashboard(data) {
            let inc = 0, exp = 0;
            data.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);
            document.getElementById('total-income').innerText = formatRupiah(inc);
            document.getElementById('total-expense').innerText = formatRupiah(exp);
            document.getElementById('net-balance').innerText = formatRupiah(inc - exp);
        }

        function renderTransactionList(data) {
            const tbody = document.getElementById('transaction-list');
            tbody.innerHTML = '';
            if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Tidak ada data.</td></tr>'; return; }
            data.slice(0, 50).forEach(t => {
                const date = new Date(t.created_at).toLocaleDateString('id-ID');
                const isInc = t.type === 'income';
                const color = isInc ? 'text-green-600' : 'text-red-600';
                const evDetails = t.event_name ? `<div class="text-xs font-bold text-blue-700">${t.event_name}</div>` : '';
                const proofBtn = t.proof_url ? `<button onclick="viewProof('${t.proof_url}')" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fa-solid fa-image"></i></button>` : '';
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-gray-500">${date}</td><td class="p-3"><div class="font-bold text-gray-700">${t.region}</div>${evDetails}</td><td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${t.category || '-'}</span></td><td class="p-3 text-xs text-gray-600 max-w-xs truncate">${t.description || '-'}</td><td class="p-3 text-right font-bold ${color}">${isInc?'+':'-'} ${formatRupiah(t.amount)}</td><td class="p-3 text-center">${proofBtn}<button onclick="editTransaction(${t.id})" class="text-yellow-600 mx-1"><i class="fa-solid fa-pen"></i></button><button onclick="deleteTransaction(${t.id})" class="text-red-500 mx-1"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function updateCharts(data) {
            const monthly = {};
            data.forEach(t => {
                const k = new Date(t.created_at).toLocaleString('id-ID', {month:'short', year:'2-digit'});
                if(!monthly[k]) monthly[k] = {inc:0, exp:0, time: new Date(t.created_at)};
                t.type === 'income' ? monthly[k].inc += t.amount : monthly[k].exp += t.amount;
            });
            const keys = Object.keys(monthly).sort((a,b) => monthly[a].time - monthly[b].time);
            
            const ctx1 = document.getElementById('cashFlowChart').getContext('2d');
            if(cashFlowChartInstance) cashFlowChartInstance.destroy();
            cashFlowChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: { labels: keys, datasets: [{label:'Masuk', data: keys.map(k=>monthly[k].inc), backgroundColor:'#22c55e'}, {label:'Keluar', data: keys.map(k=>monthly[k].exp), backgroundColor:'#ef4444'}] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
            });

            const breakdown = {};
            const isAll = currentRegionFilter === 'all';
            document.getElementById('breakdown-title').innerText = isAll ? "Pemasukan per Regional" : "Pengeluaran per Kategori";
            data.forEach(t => {
                if(isAll) { if(t.type === 'income') breakdown[t.region] = (breakdown[t.region]||0) + t.amount; } 
                else { if(t.type === 'expense') { const k = t.category || 'Lainnya'; breakdown[k] = (breakdown[k]||0) + t.amount; } }
            });
            const ctx2 = document.getElementById('breakdownChart').getContext('2d');
            if(breakdownChartInstance) breakdownChartInstance.destroy();
            breakdownChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: Object.keys(breakdown), datasets: [{ data: Object.values(breakdown), backgroundColor: ['#3b82f6', '#ef4444', '#eab308', '#22c55e', '#a855f7'] }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
            });
        }

        // --- CORE REGION MANAGEMENT (FIXED) ---
        function renderRegions() {
            // 1. Render Management List
            const list = document.getElementById('regions-list');
            list.innerHTML = '';
            regions.forEach((r, i) => {
                const li = document.createElement('li');
                li.className = 'py-2 flex justify-between border-b';
                li.innerHTML = `<span>${r}</span> <button onclick="deleteRegion(${i})" class="text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>`;
                list.appendChild(li);
            });

            // 2. Update Input Dropdown
            const inputSelect = document.getElementById('t-region');
            const currentInput = inputSelect.value;
            inputSelect.innerHTML = '';
            inputSelect.add(new Option('-- Pilih --', ''));
            regions.forEach(r => inputSelect.add(new Option(r, r)));
            if(regions.includes(currentInput)) inputSelect.value = currentInput;

            // 3. Update Dashboard Filter Dropdown (FIXED)
            const filterSelect = document.getElementById('dashboard-filter-region');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '';
            filterSelect.add(new Option('Semua Regional', 'all'));
            regions.forEach(r => filterSelect.add(new Option(r, r)));
            
            // Restore selection logic
            if (currentFilter === 'all' || regions.includes(currentFilter)) {
                filterSelect.value = currentFilter;
            } else {
                filterSelect.value = 'all';
            }

            // Save state
            localStorage.setItem('ngo_regions', JSON.stringify(regions));
        }

        function addRegion() {
            const input = document.getElementById('new-region-name');
            const val = input.value.trim();
            if(val && !regions.includes(val)) { 
                regions.push(val); 
                renderRegions(); 
                input.value=''; 
                Swal.fire('Sukses', `Regional "${val}" berhasil ditambahkan`, 'success');
            } else if (regions.includes(val)) {
                Swal.fire('Info', 'Regional sudah ada', 'info');
            }
        }
        function deleteRegion(i) { if(confirm('Hapus regional?')) { regions.splice(i,1); renderRegions(); } }

        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }
        function showLoading(b) { document.getElementById('loading').classList.toggle('hidden', !b); }
        function viewProof(u) { document.getElementById('modal-img').src=u; document.getElementById('image-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('image-modal').classList.add('hidden'); }
        
        function exportToExcel() {
            const region = document.getElementById('dashboard-filter-region').value;
            const eventName = document.getElementById('dashboard-filter-event').value;

            let dataToExport = transactions;
            let fileName = 'Laporan_Keuangan_Global';

            if (region !== 'all') {
                dataToExport = dataToExport.filter(t => t.region === region);
                fileName = `Laporan_${region}`;
                if (eventName !== 'all') {
                    dataToExport = dataToExport.filter(t => t.event_name === eventName);
                    fileName += `_${eventName}`;
                } else { fileName += `_SemuaAcara`; }
            }

            if (dataToExport.length === 0) { Swal.fire('Info', 'Tidak ada data.', 'info'); return; }

            const wsData = dataToExport.map(t => ({
                'Tanggal': new Date(t.created_at).toLocaleDateString('id-ID'),
                'Regional': t.region,
                'Acara': t.event_name || 'Operasional Rutin',
                'Kategori': t.category || '-',
                'Tipe': t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                'Jumlah': t.amount,
                'Deskripsi': t.description,
                'Bukti': t.proof_url || 'Tidak ada'
            }));

            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Keuangan");
            fileName = fileName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${fileName}_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>
